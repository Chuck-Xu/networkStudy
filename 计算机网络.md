# 计算机网络

## 第一章 计算机网络概述

### 1、计算机网络在信息时代的作用

计算机网络的重要功能

- 连通性：彼此联通，交换信息
- 共享：信息共享、软硬件共享

### 2、互联网概述

- 网络：许多计算机连接在一起
- internet（互连网）：许多网络连接在一起
- Internet（互联网/因特网）：全球最大的一个互联网

### 3、互联网的组成

**因特网的边缘部分**：由所有连接在互联网上的主机组成。这部分是用户直接使用的，用来进行通信（传送数据、音频或视频）和资源共享

- 主机之间的通信方式：
  - 客户端服务器方式(Client/Server方式—C/S)：客户是服务请求方、服务器是服务提供方
    - 客户程序:
      1. 被用户调用后运行，在通信时主动向远地服务器发起通信（请求服务)。因此，客户程序必须知道服务器程序的地址
      2. 不需要特殊的硬件和很复杂的操作系统
    - 服务器程序:
      1. 是一种专门用来提供某种服务的程序，可同时处理多个远地或本地客户的请求
      2. 系统启动后即自动调用并一直不断地运行着，被动地等待并接受来自各地的客户的
  - 对等连接方式(Peer-to-Peer方式—P2P)：两台主机在通信时不区分哪一个是服务请求方哪一个是服务提供方。只要两台主机都运行了对等连接软件(P2P软件），它们就可以进行平等的、对等连接通信，每个主机既是服务器又是客户机

**因特网的核心部分**：由大量网络和连接这些网络的路由器组成。路由器是实现分组交换(packet switching)的关键构件，其任务是转发收到的分组

为了弄清分组交换，下面先介绍电路交换的基本概念：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215113527796.png" alt="image-20201215113527796" style="zoom:67%;" />

- 电路交换：每一部电话都连接到交换机上，而交换机使用交换的方法，让电话用户彼此之间可以很方便地通信

  - 在这里，“交换”(switching)的含义就是转接——把一条电话线转接到另一条电话线，使它们连通起来
  - 从通信资源的分配角度来看，“交换”就是按照某种方式动态地分配传输线路的资源

- 电路交换特点：
  - 必须是面向连接的，分为3个阶段：
    - 建立连接：占用通信资源
    - 通信：一直占用通信资源
    - 释放连接：归还通信资源

- **分组交换：采用存储转发技术**。要发送的整块数据称为一个报文(message)，在发送报文之前，先把较长的报文划分成为一个个更小的等长数据段，在数据段前面加上一些由必要的控制信息组成的首部(header)后，构成了一个分组。**分组是在互联网中传送的数据单元**。

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215110310764.png" style="zoom:50%;" />
  
  - 首部包含了诸如目的地址和源地址等重要控制信息
  
  - 分组交换的优点：
  
    | 优点 |                         所采用的手段                         |
    | :--: | :----------------------------------------------------------: |
    | 高效 | 在分组传输的过程中动态分配传输带宽，**对通信链路是逐段占用** |
    | 灵活 |            为每一个分组独立地选择最合适的转发路由            |
    | 迅速 | 以分组作为传送单位，**可以不先建立连接就能向其他主机发送分组** |
    | 可靠 | 保证可靠性的网络协议;分布式多路由的分组交换网，使网络有很好的生存性 |
  
  - 缺点：
    - 分组在各结点存储转发时需要排队，这就会造成一定的时延
    - 分组必须携带首部(里面有必不可少的控制信息)，这造成了一定的开销

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215172433816.png" alt="image-20201215172433816" style="zoom:50%;" />

- 电路交换：整个报文的比特流连续地从源点直达终点，好像在一个管道中传送
- 报文交换：整个报文先传输到相邻的结点，全部存储下来后查找转发表，转发到下一个结点
- 分组交换：单个分组 (这只是整个报文的一部分)传送到相邻结点，存储下来后查找转发表，转发到下一个结点

### 4、计算机网络的类别

计算机网络最简单的定义：主要是由一些通用的、可编程的硬件互连而成的，而这些硬件并非专门用来实现某一特定目的(如传送数据或视频信号)

1. 按网络的作用范围进行分类
   - 广域网WAN(Wide Area Network)：作用范围通常为几十到几千公里
   - 局域网MAN(Metropolitan Area Network)：作用距离约为5~50公里
   - 局域网LAN(Local Area Network)：局限在较小的范围，约1公里左右
   - 个人区域网PAN(Personal Area Network)：范围很小，大约在10米左右

2. 按网络的使用者进行分类
   - 公用网Public Network：电信公司（国有或私有）出资建造的大型网络
   - 专用网Private Network：某个部门为满足本单位的特殊业务工作的需要而建造的网络

### 5、计算机网络的性能

#### 5.1、计算机网络的性能指标

1. 速率：指的是数据的传送速率，它也称为数据率(data rate)或比特率 (bit rate)，单位是 bit/s，或kbit/s、Mbit/s、Gbit/s 等

2. 带宽：在单位时间内网络中的某信道所能通过的“最高数据率”。单位是bit/s (比特每秒)

3. 吞吐量(throughput)：表示在单位时间内通过某个网络(或信道、接口)的数据量。吞吐量受网络的带宽或网络的额定速率的限制

4. 时延：指数据(一个报文或分组，甚至比特)从网络(或链路)的一端传送到另一端所需的时间，也称为延迟或迟延

   - 发送时延：主机或路由器发送数据帧所需要的时间

   - 传播时延：电磁波在信道中传播一定的距离需要花费的时间。**传播时延 = 信道长度(米) / 信号在信道上的传播速率(米/秒)**

   - 处理时延：主机或路由器在收到分组时要花费一定的时间进行处理，如分析首部

   - 排队时延：分组在进入路由器后要在输入队列中排队等待处理的时间，排队时延的长短往往取决于网络中当时的通信量

     <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215224008682.png" alt="image-20201215224008682" style="zoom: 50%;" />

   > 总时延  =    发送时延  + 传播时延   + 处理时延   + 排队时延

5. 时延带宽积：又称为以比特为单位的链路长度，时延带宽积 = 传播时延 × 带宽<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215224642544.png" alt="image-20201215224642544" style="zoom:50%;" />

6. 往返时间RTT：从发送方发送数据开始，到发送方收到来自接收方的确认，总共经历的时间

7. 利用率：分为信道利用率和网络利用率

   - 信道利用率：指出某信道有百分之几的时间是被利用的(有数据通过)，完全空闲的信道的利用率是零。信道利用率并非越高越好，当某信道的利用率增大时，该信道引起的时延也就迅速增加

   - 网络利用率：是全网络的信道利用率的加权平均值

   - 若令$D_0$表示网络空闲时的时延，$D$表示网络当前的时延，则在适当的假定条件下，可以用下面的简单公式表示$D$和$D_0$之间的关系$D = \frac{D_0}{1-U}$（U是网络的利用率，数值在0到1之间）


#### 5.2、计算机网络的非性能特征

主要包括：费用、质量、标准化、可靠性、可扩展性和可升级性、易于管理和维护

### 6、计算机网络的体系结构

计算机网络是个非常复杂的系统。相互通信的两个计算机系统必须高度协调工作才行，而这种“协调”是相当复杂的。

“分层”可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于研究和处理。

#### 6.1、计算机网络体系结构的形成

开放系统互连基本参考模型OSI/RM(Open Systems Interconnection Reference Model)：只要遵循OSI标准，一个系统就可以和位于世界上任何地方的、也遵循这同一标准的其他任何系统进行通信

#### 6.2、协议与划分层次

计算机网络中的数据交换必须遵守事先约定好的规则，这些规则明确规定了所交换的数据的格式以及有关的同步问题(同步含有时序的意思)。

网络协议 (network protocol)，简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定。网络协议的三个组成要素：

- 语法：数据与控制信息的结构或格式
- 语义：需要发出何种控制信息，完成何种动作以及做出何种响应
- 同步：事件实现顺序的详细说明

各层完成的主要功能：

1. 差错控制：使相应层次对等方的通信更加可靠
2. 流量控制：发送端的发送速率必须使接收端来得及接收，不要太快
3. 分段和重装 ：发送端将要发送的数据块划分为更小的单位，在接收端将其还原
4. 复用和分用：发送端几个高层会话复用一条低层的连接，在接收端再进行分用
5. 连接建立和释放：交换数据前先建立一条逻辑连接，数据传送结束后释放连接

#### 6.3、具有五层协议的体系结构

OSI 的七层协议体系结构的概念清楚，理论也较完整，但它既复杂又不实用。TCP/IP 是四层体系结构：应用层、运输层、网际层和网络接口层。但最下面的网络接口层并没有具体内容。

因此往往采取折中的办法，即综合 OSI 和 TCP/IP 的优点，采用一种只有五层协议的体系结构

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215232254985.png" alt="image-20201215232254985" style="zoom:50%;" />

- 网络排错：从底层到高层，逐一排查

- 五层协议

  - 应用层(application layer) ：包含OSI/RM网络参考模型的应用层、表示层、会话层

  - 运输层(transport layer)：负责向两台主机中进程之间的通信提供通用的数据传输服务
  - 网络层：负责为分组交换网上的不同主机提供通信服务
  - 数据链路层：在两个相邻结点间的链路上无差别的传送以帧为单位的数据。规定数据如何封装

  - 物理层：在物理层上所传数据的单位是比特。此层尽可能地屏蔽掉物理设备和传输媒体，通信手段的不同；为数据端设备提供传送数据的通路；向数据链路层提供数据（把比特流还原为数据链路层可以理解的格式）和电路标识、故障状态及服务质量参数等

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215233129762.png" alt="image-20201215233129762" style="zoom:67%;" />

#### 6.4、实体、协议、服务和服务访问点

- 实体 (entity)表示任何可发送或接收信息的硬件或软件进程
- 协议是控制两个对等实体进行通信的规则的集合
- 在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务
- 要实现本层协议，还需要使用下层所提供的服务

协议和服务在概念上是不一样的，协议的实现保证了能够向上一层提供服务。

> 本层的服务用户只能看见服务而无法看见下面的协议。即下面的协议对上面的服务用户是透明的。 
>
> **协议是“水平的”**，即协议是控制对等实体之间通信的规则。
>
> **服务是“垂直的”**，即服务是由下层向上层通过层间接口提供的。
>
> 上层使用服务原语获得下层所提供的服务

#### 6.5、TCP/IP 的体系结构

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201215234418570.png" alt="image-20201215234418570" style="zoom: 50%;" />

**路由器在转发分组时最高只用到网际层而没有使用运输层和应用层**

## 第二章 物理层

### 1、物理层的基本概念

物理层解决如何在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。

物理层的作用是要尽可能地屏蔽掉不同传输媒体和通信手段的差异。

- 物理层的主要任务描述为确定与传输媒体的接口有关的一些特性：

	- 机械特性：指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置，如接口形状、大小、引线数目

	- 电气特性：指明在接口电缆的各条线上出现的电压的范围，如规定电压范围(-5V到+5V)

	- 功能特性：指明某条线上出现的某一电平的电压的意义，如规定某一电平的电压含义(-5V表示0，+5表示1)

	- 过程特性：也称规程特性，指明对千不同功能的各种可能事件的出现顺序


### 2、数据通信的基础知识

#### 2.1、数据通信系统的模型

通信的目的是传输消息

- 一个数据通信系统包括三大部分：源系统（或发送端、发送方）、传输系统（或传输网络）和目的系统（或接收端、接收方）

- 常用术语：

	- 数据(data)：运送消息的实体

	- 信号(signal)：数据、电气或电磁的表现

	  - 模拟信号：代表消息的参数的取值是连续的，如声音

		- 数字信号：代表消息的参数的取值是离散的

	- 码元(code)：在使用时代表不同离散值间域的波形表示数字信号时，则代表不同离散值的基本波形就称为码元
- 在数字通信中常常用时间间隔相同的符号来表示一个二进制数字，只有两种不同的码元，一种代表0状态，而另一种代表1状态。这样的时间间隔内的信号称为二进制码元。而这个间隔被称为码元长度。

#### 2.2、有关信道的几个基本概念

信道一般都是用来表示向某一个方向传送信息的媒体。因此，一条通信电路往往包含一条发送信息信道和一条接收信息信道。

- **单向信道(单工通信)：**只能有一个方向的通信而没有反方向的交互

- **双向交替通信(半双工通信)：**通信的双方都可以发送信息，但不能双方同时发送（也不能同时接收）

- **双向同时通信(全双工通信)：**通信的双方可以同时发送和接收信息

- 基带(base band)信号和带通(band pass)信号

  - 基带信号：即基本频带信号——**来自信源的信号**，直接表达了要传输信息的信号。像计算机输出的代表各种文字或图像文件的数据信号、说话的声波都属于基带信号

    > 基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行调制(modulation)
    >
    > 调制分为两大类：
    >
    > - 基带调制：仅对基带信号的波形进行变换，使它能够与信道特性相适应。变换后的信号仍然是基带信号。把这种过程称为编码 (coding)
    >
    > - 带通调制：使用载波 (carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号(带通信号)，这样就能够更好地在模拟信道中传输（即仅在一段频率范围内能够通过信道）

  - 带通信号：把基带信号经过载波调制后，大信号的频率范围搬移到较高的频段以便在信道中传输(即仅在一段频率范围内能够通过信道)


##### 2.2.1、常用编码方式

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216001843179.png" alt="image-20201216001843179" style="zoom: 50%;" />

- 不归零编码：正电平代表1，负电平代表0
- 曼彻斯特编码：位周期中心的向上跳变代表0，位周期中心的向下跳变代表1。但也可反过来定义
  - bit中间有信号低—高跳变为0：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216002124328.png" alt="image-20201216002124328" style="zoom:40%;" />
  - bit中间有信号高—低跳变为1：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216002207047.png" alt="image-20201216002207047" style="zoom:40%;" />
- 查分曼彻斯特编码：在每一位bit的中心处始终都有跳变。位开始边界有跳变代表0，而位开始边界没有跳变代表1

	- **bit中间有信号跳变，bit与bit之间也有信号跳变，表示下一个bit为0**：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216002322807.png" alt="image-20201216002322807" style="zoom:40%;" />
	- **bit中间有信号跳变，bit与bit之间无信号跳变，表示下一个bit为1**：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216002336313.png" alt="image-20201216002336313" style="zoom:40%;" />

##### 2.2.2、基本的带通调制方法

基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。为了解决这一问题，就必须对基带信号进行调制 (modulation)。 

最基本的二元制调制方法有以下几种：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216113012899.png" alt="image-20201216113012899" style="zoom:45%;" />

- 调幅(AM)：载波的振幅随基带数字信号而变化。如0或1分别对应于无载波或有载波输出

- 调频(FM)：载波的频率随基带数字信号而变化。如0或1分别对应于频率 f<sub>1</sub> 或 f<sub>2</sub>

- 调相(PM) ：载波的初始相位随基带数字信号而变化。如0或1分别对应于相位0度或180度

##### 2.2.3、信道的极限容量

实际信道传输问题：任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰

从概念上讲，限制码元在信道上的传输速率的因素有以下两个：

- 信道能够通过的频率范围：具体的信道所能通过的频率范围总是有限的。信号中的许多高频分量往往不能通过信道
  - 奈氏准则：在任何信道中，码元传输的速率是有上限的，传输速率超过此上限，就会出现严重的码间串扰的问题，使接收端对码元的判决（即识别）成为不可能。如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰。
    - 理想低通信道的最高码元传输速率 = 2WBaud（W是理想低通信道的带宽，单位为HZ。Baud：波特，码元传输速率的单位)
  
- 信噪比：信号的平均功率和噪声的平均功率之比。常记为 S/N，并用分贝 (dB) 作为度量单位。即：

   信噪比(dB) = 10×log<sub>10</sub>(S/N) (dB)，如当 S/N=10 时，信噪比为 10 dB，而当 S/N=1000时，信噪比为30dB 

  - 香农公式：信道的极限信息传输速率 C 可表达为：C = W×log<sub> 2</sub>(1+S/N)  (bit/s) 
    
    - W 为信道的带宽（以 Hz 为单位），不可能无限提高
    
    - S 为信道内所传信号的平均功率，
    
    - N 为信道内部的高斯噪声功率 
    
    > 香农公式表明： 
    >
    > 信道的带宽或信道中的信噪比越大，信息的极限传输速率就越高
    > 只要信息传输速率低于信道的极限信息传输速率，就一定能找到某种办法来实现无差别的传输
    > 若信道带宽W或信噪比S/N没有上线（实际信道不可能是这样的），则信道的极限信息传输速率C也就没有上限
    > 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少

### 3、物理层下面的传输媒体

传输媒体可分为两大类：导引型传输媒体和非导引型传输媒体

- 导引型传输媒体(导向传输媒体)：导引传输媒体中，电磁波沿着固体媒体（铜线或光纤）传播

  - 双绞线：最常用的传输媒体，分为屏蔽双绞线和无屏蔽双绞线

  - 同轴电缆：同轴电缆具有很好的抗干扰特性，被广泛用于传输较高速率的数据

    - 50Ω同轴电缆 用于数字传输，多用于基带传输，也叫基带同轴电缆
    - 75Ω同轴电缆 用于模拟传输，即宽带同轴电缆

  - 光缆

  	- 单模光缆：只能使一种光线一直向前传播，而不会产生多次反射

  	- 多模光缆：可以存在多条不同角度入射的光线在一条光纤中传输

- 非导引型传输媒体(非导向传输媒体)

  - 无线传输所使用的频段很广。
  - 短波通信（即高频通信）主要是靠电离层的反射，但短波信道的通信质量较差，传输速率低
  - 微波在空间主要是直线传播
  - 传统微波通信有两种方式： 
    - 地面微波接力通信
    - 卫星通信 

### 4、信道复用技术

复用(multiplexing)是通信技术中的基本概念。在发送端使用一个复用器，多个用户使用一个共享信道进行通信。在接收端再使用分用器，把合起来传输的信息分别送到相应的终点。

#### 4.1、频分复用、时分复用和统计时分复用

- 频分复用FDM (Frequency Division Multiplexing)：用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。频分复用的所有用户在同样的时间占用不同的带宽资源（注意，这里的带宽是频率带宽，不是数据的发送速率）<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201217091446380.png" alt="image-20201217091446380" style="zoom:50%;" />

- 时分复用TDM(Time Division Multiplexing)：将时间划分为一段段等长的时分复用帧(TDM帧）。每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201216152735917.png" alt="image-20201216152735917" style="zoom:50%;" />

- 统计时分复用STDM (Statistic TDM)：改进的时分复用。把缓存中的用户输入数据放入STDM帧，对应的STMD帧有对应的标记，来区分不同用户的数据

波分复用WDM (Wavelength Division Multiplexing)：光的频分复用

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201217091337673.png" alt="image-20201217091337673" style="zoom:50%;" />

#### 4.2、码分复用

码分复用CDM(Code Division Multiplexing)：常用的名词是码分多址CDMA (Code Division Multiple Access)，各用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰。这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现

- 码片(chip)：每一个比特时间划分为 m 个短的间隔

- 每个站被指派一个唯一的 m bit 码片序列。

  如发送比特 1，则发送自己的 m bit 码片序列。

  如发送比特 0，则发送该码片序列的二进制反码。

  > 如：S 站的 8 bit 码片序列是 00011011，
  >
  > 发送比特 1 时，就发送序列 00011011，发送比特 0 时，就发送序列 11100100。
  >
  >  按惯例将码片中的0写为-1，将1写为+1，s站的码片序列：(–1 –1 –1 +1 +1 –1 +1 +1) 

CDMA的重要特点：**每个站分配的码片序列不仅必须各不相同，并且还必须互相正交 (orthogonal)**。在实用的系统中是使用伪随机码序列。

令向量 S 表示站 S 的码片向量，令 T表示其他任何站的码片向量。

**两个不同站的码片序列正交，就是向量 S 和T 的规格化内积 (inner product) 等于0**：<strong>$S \cdot T = \frac{1}{m}\sum_{i=1}^{m} S_{i}T_i = 0$</strong>

**任何一个码片向量和该码片向量自己的规格化内积都是1**：$S \cdot T = \frac{1}{m}\sum_{i=1}^mS_iS_i= \frac{1}{m}\sum_{i=1}^mS_i^2 = \frac{1}{m}\sum_{i=1}^m(\pm1)^2) = 1$

**一个码片向量和该码片反码的向量的规格化内积值是 –1**

- CDMA的工作原理：

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201217100753966.png" alt="image-20201217100753966" style="zoom:50%;" />

  设S站要发送的数据是110三个码元。再设CDMA将每一个码元扩展为8个码片，而S站选择的码片序列为`(-1 -1 -1 +1 +1 -1 +1 +1)`。S站发送的扩频信号为Sx。T站选择的码片序列为`(-1 -1 +1 -1 +1 +1 +1 -1)`，即S站的正交码片序列。T站也发送110三个码元，而T站的扩频信号为Tx。因所有的站都使用相同的频率，因此每S站和T产生了叠加的信号 S<sub>x</sub>+ T<sub>x</sub>，在不知道码片序列时，叠加信号是没有意义的，需要用S · (S<sub>x</sub>+ T<sub>x</sub>)求出信号，由于S · T<sub>x</sub>=0(两个码片序列是正交的)，所以只需要求S·S<sub>x</sub>，若S · S<sub>x</sub>=1，则得出图中S发送的比特为1；S · S<sub>x</sub>=-1，S发送的比特为0

> 练习：共有4个站进行码分多址CDMA通信，四个站的码片序列为:
> A：(-1 -1 -1 +1 +1 -1 +1 +1)	B：(-1 -1 +1 -1 +1 +1 +1 -1)
> C：(-1 +1 -1 +1 +1 +1 -1 -1)	D：(-1 +1 -1 -1 -1 -1 +1 -1)
> 现收到这样的码片序列(-1 +1 -3 +1 -1 -3 +1 +1)，问：哪个站发送数据了? 发送的是1还是0?
>
> S·A =（+1 -1 +3 +1 -1 +3 +1 +1）／8 = 1， A发送1
> S·B =（+1 -1 -3  -1 -1 -3 +1 -1）／8 =  -1， B发送0
> S·C =（+1 +1 +3 +1 -1 -3 -1 -1）／8 = 0， C无发送
> S·D =（+1 +1 +3 -1 +1 +3 +1 -1）／8 = 1， D发送1

## 第三章 数据链路层

数据链路层使用的信道主要有以下两种类型：

- 点对点信道：使用一对一的点对点通信方式

- 广播信道：使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

### 1、使用点对点信道的数据链路层

#### 1.1、数据链路和帧

链路(link)：是从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。两台计算机之间进行数据通信时往往要经过许多段这样的链路。链路只是一条通路的组成部分。

- 数据链路(data link)：除了一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
  现最常用的方法是使用适配器(即网卡)来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。

- 帧：数据链路层像一个数字管道，在这条数字管道上传输的数据单位就是帧。点对点信道的数据链路层的协议数据单元


#### 1.2、三个基本问题

- 封装成帧(framing)：就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。首部和尾部的一个重要作用是确定帧的界限。据部分长度上限——最大传送单元MTU(Maximum Transfer Unit)

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201217113019839.png" alt="image-20201217113019839" style="zoom: 33%;" />

  最大传送单元MTU(Maximum Transfer Unit)：所能传送的帧的数据部分长度上限（IP数据报的最大长度）

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201217113711260.png" alt="image-20201217113711260" style="zoom: 40%;" />

  帧定界可以使用特殊的帧定界符。控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个控制字符 EOT (End Of Transmission) 表示帧的结束

- 透明传输：不管从键盘上输入什么字符都可以放在这样的帧中传输过去。为了解决帧界定错误问题，就必须设法使数据中可能出现的控制字符“SOH"或“EOT"在接收端不被解释为控制字符。

  - 解决方法：字节填充 (byte stuffing)(异步网络使用)或字符填充 (character stuffing)(同步网络使用)：发送端的数据链路层在数据中出现控制字符"SOH"或“EOT"的前面插入一个转义字符“ESC"

- 差错控制：传输过程中可能会产生比特差错：1可能会变成0；而 0 也可能变成1

  - 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER (Bit Error Rate)
  
  - 误码率与信噪比有很大的关系
  
  - 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施
  

循环冗余检验CRC(Cyclic Redundancy Check)的检错技术：

在发送端，先把数据划分为组。假定每组 k个比特。 假设待传送的一组数据 M=101001(现在k=6)。我们在 M 的后面再添加供差错检测用的 n 位冗余码，然后构成一个帧发送出去，一共发送(k + n)位。

用二进制的模 2 运算进行 2<sup>n</sup> 乘 M 的运算，这相当于在 M 后面添加 n 个0。得到的 (k+n) 位的数除以事先选定好的长度为(n+1)位的除数 P，得出商是 Q 而余数是 R，余数 R 比除数 P 少1位，即 R是 n 位。

将余数 R 作为冗余码拼接在数据 M 后面发送出去。让接收方用(M + R)位的数除以除数P

- 若得出的余数R=0，则判定这个帧没有差错，就接受 (accept)

- 若余数 R$\neq$0，则判定这个帧有差错，就丢弃

> 现在 k = 6, *M* = 101001
> 设 n = 3, 除数 P = 1101，被除数是 2<sup>n</sup> *M* = 101001000
> 模 2 运算的结果是：商 Q = 110101，余数 R = 001
> 把余数 R 作为冗余码添加在数据 M 的后面发送出去。发送的数据是： 2<sup>n</sup> *M* + R
>
> 即：发送的数据：101001001，共 (k + n) 位
>
> - 循环冗余检验的原理：
>
>   <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219101439973.png" alt="image-20201219101439973" style="zoom: 40%;" />

> 习题：要发送的数据为101110。采用CRC的生成多项式是P(X) = X<sup>3</sup>+1。试求应添加在数据后面的余数。
>
> M=101110，P(X) = 1×X<sup>3</sup> + 0×X<sub>2</sub> + 0×X<sup>1</sup> + 1×X<sup>0</sup> = 1001
>
> 可得用二进制表示的除数P= 1001 。除数是4位。在数据后面要添加3个0，所以拿 101110==000== 除以 1001
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219102925218.png" alt="image-20201219102925218" style="zoom: 67%;" />

**注意：仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受 (accept)**

- “无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”。也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）

- 要做到“可靠传输”（即发送什么就收到什么）就必须再加上确认和重传机制

- 在数据链路层使用CRC检验，能够实现无比特差错的传输，但这还不是可靠传输

==**本章介绍的数据链路层协议都不是可靠传输的协议**==

### 2、点对点协议PPP

#### 2.1、PPP协议的特点

点到点ppp协议(Point-to-Point Protocol)：用户计算机和互联网服务提供商 ISP(Internet Service Provider)进行通信时所使用的数据链路层协议

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219104724365.png" alt="image-20201219104724365" style="zoom:50%;" />

PPP协议应满足的需求：

- 简单——这是首要的要求
- 封装成帧——必须规定特殊的字符作为帧定界符
- 透明性——必须保证数据传输的透明性
- 多种网络层协议——必须能够在在同一条物理链路上同时支持多种网络层协议（如IP、IPX等）的运行

- 多种类型链路——能够在多种类型的链路上运行。例如，串行的（一次只发送一个比特）或并行的（一次并行地发送多个比特），同步的或异步的，低速的或高速的，电的或光的，交换的（动态的）或非交换的（静态的）点对点链路

- 差错检测——能够对接收端收到的帧进行检测，并立即丢弃有差错的帧
- 检测连接状态——能够及时自动检测出链路是否处于正常工作状态
- 最大传送单元——必须对每一种类型的点对点链路设置最大传送单元 MTU 的标准默认值，促进各种实现之间的互操作性
- 网络层地址协商——必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址
- 数据压缩协商——必须提供一种方法来协商使用数据压缩算法

PPP协议的组成

- 一个将IP数据报封装到串行链路的方法，既支待异步链路（无奇偶检验的特数据），也支持面向比特的同步链路。IP数据报在PPP帧中就是其信息部分，其长度受最大传送单元MTU的限制

- 一个用来建立、配置和测试数据链路连接的链路控制协议LCP(Link Control Protocol)
- 一套网络控制协议NCP(Network Control Protocol)，其中的每一个协议支持不同的网络层协议，如IP、OSI的网络层、DECnet，以及AppleTalk等


#### 2.2、PPP协议的帧格式

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219110307010.png" alt="image-20201219110307010" style="zoom: 50%;" />

PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。

- 标志字段F=0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）

- 地址字段A 只置为 0xFF。地址字段实际上并不起作用

- 控制字段C 通常置为 0x03

==PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节==

透明传输问题：

- 当 PPP 用在异步传输时，就使用一种特殊的字节填充法 
  - 字节填充：当信息字段中出现和标志字段的值，会被被误认为“标志”怎么办？
    - 把信息字段中出现的每一个 0x7E 字节转变成为字节序列(0x7D, 0x5E)
    - 若信息字段中出现一个 0x7D 的字节（即出现了和转义字符一样的比特组合），则 0x7D 转变成为字节序列(0x7D, 0x5D)
    - 若信息字段中出现 ASCII 码的控制字符（即数值小于0x20的字符)，则在该字符前面要加入一个0x7D字节，同时将该字符的编码加以改变

- 当 PPP 用在同步传输链路时，协议规定采用硬件来完成零比特填充

  - 零比特填充：在发送端，只要发现有 5个连续1，则立即在后面填入一个0。接收端对帧中的比特流进行扫描；每当发现 5个连续1时，就把这 5个连续1后的一个0删除

  > 练习：
  >
  > 1. 一个PPP帧的数据部分(十六进制）是7D 5E FE 27 7D 5D 7D 5D 65 7D 5E请问真正的数据是什么?
  >
  >    找出转义的字节：==7D 5E== FE 27 ==7D 5D== ==7D 5D== 65 ==7D 5E==
  >    转换后：7E FE 27 7D 7D 65 7E
  >
  > 2. PPP协议使用同步传输技术传送比特串0110111111111100，则经过零比特填充后变成怎样的比特串?
  >
  >    011011111 ==0== 11111 ==0== 00
  >
  > 3. 若接收端收到的PPP帧的数据部分是0001110111110111110110，则删除发送端加入的零比特后，得到的原始比特串是什么? 
  >
  >    由题目知：000111011111 ==0== 11111 ==0== 110，则原始比特串：00011101111111111110

PPP 协议之所以不使用序号和确认机制是出于以下的考虑：

- 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理
- 在因特网环境下，PPP的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的
- 帧检验序列FCS字段可保证无差错接受

#### 2.3、PPP协议的工作状态

当用户拨号接入ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。PC机向路由器发送一系列的LCP分组(封装成多个PPP帧)。
这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机成为因特网上的一个主机
通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的是物理层的连接

可见，==PPP协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容==。

### 3、使用广播信道的数据链路层

广播信道：使用一对多的广播通信方式，因此过程比较复杂

#### 3.1、局域网的数据链路层

局域网使用的就是广播信道

- 局域网的特点和优点

	- 特点：网络为一个单位所拥有，且地理范围和站点数目均有限
- 优点：
	
  1. 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源
	2. 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
  3. 提高了系统的可靠性(reliability)、可用性(availability)和生存性(survivability)
	- 共享通信媒体资源的两种方法：
	  - 静态划分信道：如在第2章的2.4节中已经介绍过的频分复用、时分复用、波分复用和码分复用等
	  - 动态媒体接入控制（多点接入）
	    1. 随机接入：所有的用户可随机地发送信息。但如果恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上就要产生碰撞（即发生了冲突），使得这些用户的发送都失败
	    2. 受控接入：用户不能随机地发送信息而必须服从一定的控制。如多点线路探询 (polling)，或轮询

##### 3.1.1、以太网的两个标准

DIX Ethernet V2是世界上第一个局域网产品（以太网）的规约；IEEE 802.3 是第一个 IEEE 的以太网标准。

DIX Ethernet V2标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3局域网简称为“以太网”，严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网

- 数据链路层的两个子层：

  - 逻辑链路控制LLC (Logical Link Control)子层
  - 媒体接入控制MAC (Medium Access Control)子层

  与接入到传输媒体有关的内容都放在 MAC子层，而**LLC子层则与传输媒体无关**。

  不管采用何种协议的局域网，对 LLC 子层来说都是透明的。

##### 3.1.2、适配器的作用

网络接口板又称为通信适配器(adapter)或网络接口卡 NIC (Network Interface Card)，或“网卡”。

适配器的重要功能：

- 进行串行/并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议

#### 3.2、CSMA/CD协议

为了通信的简便，以太网采取了两种重要的措施：

1. **采用较为灵活的无连接的工作方式**：不必先建立连接就可以直接发送数据

   - 对发送的数据帧不进行编号，也不要求对方发回确认
   - 这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的

   **以太网提供的服务是不可靠的交付，即尽最大努力的交付。**
   当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。差错的纠正由高层来决定。
   如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。

2. **以太网发送的数据使用曼彻斯特 (Manchester) 编码**

以太网使用的协议：CSMA/CD协议——载波监听多点接入／碰撞检测(Carrier Sense Multiple Access with Collision Detection)

“多点接入”：许多计算机以多点接入的方式连接在一根总线上
“载波监听”：每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞

“碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219141053343.png" alt="image-20201219141053343" style="zoom:50%;" />

> 在`t=0`时，A发送数据。B检测到信道为空闲。
> 在`t = τ- δ`时(这里 τ > δ > 0)，A发送的数据还没有到达B时，由于B检测到信道是空闲的，因此B发送数据。
> 经过时间`δ/2`后，即在`t = τ - δ/2`时，A发送的数据和B发送的数据发生了碰撞。但这时A和B都不知道发生了碰撞。
> 在`t=τ`时，B检测到发生了碰撞，于是停止发送数据。
> 在`t=2τ-δ`时，A也检测到发生了碰撞，因而也停止发送数据。A和B发送数据均失败，它们都要推迟一段时间再重新发送。

使用 CSMA/CD 协议一个站不可能同时进行发送和接收（但必须边发送边监听信道）。因此使用CSMA/CD协议的以太网只能进行双向交替通信（半双工通信）

争用期：以太网的端到端往返时延 2t ，又称碰撞窗口。最先发送数据帧的站，在发送数据帧后至多经过时间2t (两倍的端到端往返时延)就可知道发送的数据帧是否遭受了碰撞。==**经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞**==

二进制指数类型退避算法(truncated binary exponential type)：

- 发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。

- 基本退避时间取为争用期 2$τ$。

- 从整数集合 [0, 1, … , (2<sup>k</sup> -1)] 中随机地取出一个数，记为 *r*。重传所需的时延就是 *r* 倍的基本退避时间。

- 参数 k 按公式计算： k = *Min*[重传次数, 10]
  - 当 k≤10 时，参数 k 等于重传次数。
  - 当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告

例如，在第1次重传时，k=1，随机数 *r* 从整数{0, 1}中选一个数。因此重传的站可选择的重传推迟时间是 0 或 2r，在这两个时间中随机选择一个。
若再发生碰撞，则在第2次重传时，k=2，随机数 *r* 就从整数{0, 1, 2, 3}中选一个数。因此重传推迟的时间是在0, 2r, 4r和6r这4个时间中随机地选取一个。依此类推。

10Mbit/s 以太网取 51.2ms 为争用期的长度。对于 10Mbit/s 以太网，在争用期内可发送 512bit (10Mbit/s × 51.2ms)，即 64 字节。
以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突。说明在传输中，大于64字节的帧才被认为正常的帧，小于64字节的帧被称为残帧

**最短有效帧长：以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。**如果发生冲突，就一定是在发送的前 64 字节之内

- 强化碰撞：当发送数据的站一旦发现发生了碰撞时：
  - 立即停止发送数据
  - 再继续发送若干比特的人为干扰信号 (jamming signal)，以便让所有用户都知道现在已经发生了碰撞
  - 以太网的信道利用率

==**口诀：先听后发，边听边发，冲突停止，随机重发**==

#### 3.3、使用集线器的星形拓扑

集线器(hub)：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219151403038.png" alt="image-20201219151403038" style="zoom:50%;" />

1. 集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行
2. 使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线
3. 集线器很像一个多接口的转发器，工作在物理层
4. 集线器采用了专门的芯片，进行自适应串音回波抵消，减少了近端串音

#### 3.4、以太网的信道利用率 

多个站在以太网上同时工作就可能会发生碰撞。
当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到 100%。

假设 $τ$ 是以太网单程端到端传播时延。则争用期长度为 $2τ$，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号帧长为L(bit)，数据发送速率为 C(b/s)，因而帧的发送时间为T~0~ = L/C(S)

以太网信道被占用的情况：一个站在发送帧时出现了碰撞。经过一个争用期 2$τ$ 后，可能又出现了碰撞。这样经过若干个争用期后，一个站发送成功了。假定发送帧需要的时间是 T<sub>0</sub>

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219152108164.png" alt="image-20201219152108164" style="zoom:50%;" />

要提高以太网的信道利用率，就必须减小 $τ$ 与 T<sub>0</sub> 之比。

在以太网中定义了参数 α，它是以太网单程端到端时延 $τ$ 与帧的发送时间 T~0~ 之比： α= $τ$ / T<sub>0</sub>

- α→0表示发生碰撞就立即可以检测出来，并立即停止发送，因而信道利用率很高
- α越大， 表明争用期 2$τ$ 所占的比例增大，每发生次碰撞就浪费许多信道资源，使得信道利用率明显降低

为提高利用率，以太网的参数a的值应当尽可能小些。对以太网参数 α 的要求是：

- 当数据率一定时，以太网的连线的长度受到限制，否则 $τ$ 的数值会太大
- 以太网的帧长不能太短(T<sub>0</sub> = L / C)，否则 T<sub>0</sub> 的值会太小，使 α 值太大

在理想化的情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是 CSMA/CD，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一个站立即发送数据。发送一帧占用线路的时间是 T<sub>0</sub> + $τ$，而帧本身的发送时间是 T<sub>0</sub>。

于是我们可计算出理想情况下的极限信道利用率 S<sub>max</sub> 为：**$S_{max} = \frac{T_0}{T_0 + τ} = \frac{1}{1 + a}$**

#### 3.5、以太网的MAC层

##### 3.5.1、MAC层的硬件地址

在局域网中，硬件地址又称为物理地址或MAC地址（因为这种地址用在MAC层中）

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219164029902.png" alt="image-20201219164029902" style="zoom:50%;" />

MAC 地址字段可采用 6 字节 ( 48位)。地址字段 6 个字节中的前三个字节(即高位 24 位)，称为组织唯一标识符。后三个字节 (即低位 24 位) 由厂家自行指派，称为扩展唯一标识符。MAC地址是唯一的，没有重复地址。MAC地址实际上就是适配器地址

- 适配器检查MAC地址：适配器从网络上每收到一个MAC 帧就首先用硬件检查MAC帧中的MAC地址。如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此帧丢弃，不再进行其他的处理。

  - “发往本站的帧”包括以下三种帧：
  
    - 单播(unicast)帧(一对一)
    - 广播(broadcast)帧(一 对全体)
    - 多播(multicast)帧(一 对多)
  
    所有的适配器都至少能够识别前两种帧，即能够识别单播地址和广播地址

##### 3.5.2、MAC帧的格式

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219165457722.png" alt="image-20201219165457722" style="zoom:50%;" />

- 无效的MAC帧：

  - 帧的长度不是整数个字节
  - 用收到的帧检验序列FCS 查出有差错
  - 数据字段的长度不在46\~1500字节之间，有效的MAC帧长度为64~1518 字节之间
  
  对于检查出的无效MAC帧就简单地丢弃。以太网不负责重传丢弃的帧

> 练习：
>
> 假定1km长的CSMA/CD网络的数据率为1Gbit/s,信号在网络上的传播速率为2×10<sup>5</sup>km/s，求此时协议的最短帧长
>
> 2$τ$ = 1 ÷ 2 * 10<sup>5</sup> * 2 = 10<sup>-5</sup> s
>
> 10<sup>9</sup> bit/s * 2$τ$ =  10<sup>9</sup> bit/s * 10<sup>-5</sup> s = 10<sup>4</sup> bit = 1250B

### 4、扩展以太网

#### 4.1、在物理层扩展以太网

1. 使用光纤扩展：

   - 主机使用光纤（通常是一对光纤）和一对光纤调制解调器连接到集线器
   - 很容易使主机和几公里以外的集线器相连接

   <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219230308700.png" alt="image-20201219230308700" style="zoom:50%;" />

   主机使用光纤和一对光纤调制解调器连接到集线器

2. 使用集线器扩展：使用多个集线器可连成更大的、多级星形结构的以太网

   <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201219230601051.png" alt="image-20201219230601051" style="zoom: 50%;" />

   - 优点：
     - 使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信
     - 扩大了以太网覆盖的地理范围
   - 缺点：
     - 碰撞域增大了，但总的吞吐量并未提高
     - 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来

#### 4.2、在数据链路层扩展以太网

- 使用网桥(bridge)：网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发。网桥具有过滤帧的功能；当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC地址，然后再确定将该帧转发到哪一个接口。
目前使用得最多的网桥是透明网桥(transparent bridge)。“透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的。
  
- 使用以太网交换机(switch)：实质上就是一个多接口的网桥。每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都==工作在全双工方式==

  - 以太网交换机具有并行性，即能同时连通多对接口，使多对主机能同时通信（而网桥只能一次分析和转发一个帧）。相互通信的主机都是独占传输媒体，无碰撞地传输数据。

  - 优点：

    - 用户独享带宽，增加了总容量：对于普通 10 Mbit/s 的共享式以太网，若共有 N 个用户，则每个用户占有的平均带宽只有总带宽 (10 Mbit/s)的 N 分之一。使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mbit/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 N 个接口的交换机的总容量为 N×10 Mbit/s。

    - 从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动
    - 以太网交换机一般都具有多种速率的接口，方便了各种不同情况的用户

以太网交换机的交换方式：

- 存储转发方式：把整个数据帧先缓存后再进行处理
- 直通 (cut-through) 方式：接收数据帧的同时就立即按数据帧的目的 MAC 地址决定该帧的转发接口，因而提高了帧的转发速度
  - 缺点是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站

##### 4.2.1、以太网交换机的自学习功能

以太网交换机运行自学习算法自动维护交换表。开始时，以太网交换机里面的交换表是空的。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220001016807.png" alt="image-20201220001016807" style="zoom:50%;" />

A先向 B 发送一帧，从接口 1 进入到交换机。交换机收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧。

交换机把这个帧的源地址 A 和接口 1 写入交换表中，并向除接口 1 以外的所有的接口广播这个帧。C和 D 将丢弃这个帧，因为目的地址不对。只 B 才收下这个目的地址正确的帧。这称为过滤。

从新写入交换表的项目 (A, 1) 可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A，就应当把收到的帧从接口1转发出去

B 通过接口 3 向 A 发送一帧。

交换机查找交换表，发现交换表中的 MAC地址有A。表明要发送给A的帧（即目的地址为 A 的帧）应从接口1转发。于是就把这个帧传送到接口 1 转发给A。显然，现在已经没有必要再广播收到的帧。

交换表这时新增加的项目 (B, 3)，表明今后如有发送给 B 的帧，就应当从接口 3 转发出去。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220001856775.png" alt="image-20201220001856775" style="zoom:50%;" />

经过一段时间后，只要主机 C 和 D 也向其他主机发送帧，以太网交换机中的交换表就会把转发到 C 或 D 应当经过的接口号（2 或 4）写入到交换表中

**以太网交换机的这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置，因此非常方便**

交换机自学习和转发帧的步骤归纳：

1. 交换机收到一帧后先进行自学习。查找交换表中与收到帧的源地址有无相匹配的项目。
   - 若没有，就在交换表中增加一个项目（源地址、进入的接口和有效时间）
   - 若有，则把原有的项目进行更新（进入的接口或有效时间）

2. 转发帧。查找交换表中与收到帧的目的地址有无相匹配的项目
   - 如没有，则向所有其他接口（进入的接口除外）广播转发
   - 如有，则按交换表中给出的接口进行转发
   - 若交换表中给出的接口就是该帧进入交换机的接口，则应丢弃这个帧（因为这时不需要经过交换机进行转发）

交换机使用了生成树协议

增加冗余链路时，自学习的过程就可能导致以太网帧在网络的某个环路中无限制地兜圈子。

如图，假定开始时，交换机 #1 和 #2 的交换表都是空的，主机 A 通过接口交换机 #1 向主机 B 发送一帧

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220112824019.png" alt="image-20201220112824019" style="zoom: 50%;" />

广播风暴：按交换机自学习和转发方法，该帧的某个走向如下：离开交换机 #1 的接口 3 → 交换机 #2 的接口 1 → 接口 2 → 交换机 #1 的接口 4 → 接口 3 → 交换机 #2 的接口 1 →……。这样就无限制地循环兜圈子下去，白白消耗了网络资源。

IEEE802.1D 标准制定了一个生成树协议 STP(Spanning Tree Protocol)：不改变网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是无环路的树状结构，从而消除了兜圈子现象

##### 4.2.2、从总线以太网到星形以太网

**总线以太网使用 CSMA/CD 协议，以半双工方式工作**。

以太网交换机不使用共享总线，没有碰撞问题，因此不使用 CSMA/CD 协议，而是以全双工方式工作。但仍然采用以太网的帧结构

#### 4.3、虚拟局域网VLAN(Virtual LAN)

虚拟局域网VLAN(Virtual LAN)：由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。==每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN==。以太网交换机根据标识符发送数据到指定的 VLAN 中，数据链路层划分 VLAN 后，数据链路层中处于不同的 VLAN 的主机就不能相互通信，给网络层解决。

虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。利用以太网交换机可以很方便地实现虚拟局域网。

虚拟局域网限制了接收广播信息的工作站数，使得网络不会因传播过多的广播信息(即“广播风暴”)而引起性能恶化。 

**虚拟局域网使用的以太网帧格式**：

IEEE批准了802.3ac 标准，该标准定义了以太网的帧格式的扩展，以支持虚拟局域网。

虚拟局域网协议允许在以太网的帧格式中插入一个4字节的标识符，称为 VLAN标记 (tag)，用来指明发送该帧的计算机属于哪一个虚拟局域网。**插入 VLAN 标记得出的帧称为 802.1Q帧 或 带标记的以太网帧**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220150823772.png" alt="image-20201220150823772" style="zoom: 50%;" />

### 5、高速以太网

速率达到或超过100 Mb/s的以太网称为高速以太网

#### 5.1、100BASE-T以太网

在双绞线上传送100 Mb/s基带信号的星型拓扑以太网，仍使用IEEE 802. 3的CSMA/CD协议。100BASE-T以太网又称为快速以太网(Fast Ethernet)

- 特点：
  - 可在全双工方式下工作而无冲突发生。因此不使用CSMA/CD 协议
  - MAC帧格式仍然是802.3标准规定的
  - 保持最短帧长不变，但将一个网段的最大电缆长度减小到100m帧间时间间隔从原来的9.6μs改为现在的0.96 μs

#### 5.2、吉比特以太网

吉比特以太网可用作现有网络的主干网，也可在高带宽（高速率）的应用场合中

- 特点：
  - 允许在1Gb/s下全双工和半双工两种方式工作
  - 使用802. 3协议规定的帧格式
  - 在半双工方式下使用CSMA/CD 协议，全双工方式不需要使用CSMA/CD协议
  - 与10BASE-T 和100BASE-T技术向后兼容
  - 当吉比特以太网工作在全双工方式时(即通信双方可同时进行发送和接收数据)，不使用载波延伸和分组突发

## 第四章 网络层

网络层关注的是如何将分组从源端沿着网络路径送达目的端。**可靠传输：传输帧不丢失、不重复、不失序**

### 1、网络层提供的两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务(“面向连接”还是“无连接”)曾引起了长期的争论。
争论焦点的实质就是：在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？

#### 1.1、虚电路服务

虚电路服务：让网络负责可靠交付，计算机网络应模仿电信网络，使用面向连接的通信方式。通信之前先建立虚电路(Virtual Circuit)连接，以保证双方通信所需的一切网络资源。若再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

- 虚电路连接只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
- 请注意，电路交换的电话通信是先建立了一条真正的连接。因此分组交换的虚电路连接和电路交换的连接只是类似，并不完全一样。

#### 1.2、数据报服

数据报服务：让端系统负责可靠交付，网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。
网络在发送分组时不需要先建立连接。每一个分组 (即IP数据报) 独立发送，与其前后的分组无关(不进行编号)。
**网络层不提供服务质量的承诺**。所传送的分组可能出错、丢失、重复和失序（即不按序到达终点），当然也不保证分组传送的时限

- 尽最大努力交付的好处:

  - 传输网络不提供端到端的可靠传输服务，就使网络中的路由器可以做得比较简单，而且价格低廉(与电信网的交换机相比较)
  - 如果主机(即端系统)中的进程之间的通信需要是可靠的，就由网络的主机中的运输层负责可靠交付(包括差错处理、流量控制等)
  - 采用这种设计思路的好处是:网络的造价大大降低，运行方式灵活，能够适应多种应用
  - 因特网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性

- 虚电路与数据报服务比较

  | 对比的方面                 | 虚电路服务                                     | 数据报服务                                         |
  | :------------------------- | :--------------------------------------------- | -------------------------------------------------- |
  | 思路                       | 可靠通信应当由网络来保证                       | 可靠通信应当由用户主机来保证                       |
  | 连接的建立                 | 必须有                                         | 不需要                                             |
  | 终点地址                   | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有终点的完整地址                         |
  | 分组的转发                 | 属于同一条虚电路的分组均按照同一路由进行转发   | 每个分组独立选择路由进行转发                       |
  | 当结点出故障时             | 所有通过出故障的结点的虚电路均不能工作         | 出故障的结点可能会丢失分组，一些路由可能会发生变化 |
  | 分组的顺序                 | 总是按发送顺序到达终点                         | 到达终点时不一定按发送顺序                         |
  | 端到端的差错处理和流量控制 | 可以由网络负责，也可以由用户主机负责           | 由用户主机负责                                     |

### 2、网际协议IP

网际协议 IP是 TCP/IP体系中两个最主要的协议之一。

与 IP协议配套使用的还有三个协议：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220162620490.png" alt="image-20201220162620490" style="zoom:50%;" />

- 地址解析协议ARP (Address Resolution Protocol)

- 网际控制报文协议ICMP (Internet Control Message Protocol)

- 网际组管理协议IGMP (Internet Group Management Protocol)

#### 2.1、虚拟互连网络

将网络互连并能够互相通信，会遇到许多问题需要解决，如：

不同的寻址方案、不同的最大分组长度、不同的网络接入机制、不同的超时控制、不同的差错恢复方法、不同的状态报告方法、不同的路由选择技术、不同的用户接入控制、不同的服务（面向连接服务和无连接服务）、不同的管理与控制方式等

如何将异构的网络互相连接起来？

- 使用一些中间设备进行互连，中间设备又称为中间系统或中继(relay)系统
  - 有以下五种不同的中间设备：
    - 物理层中继系统：转发器 (repeater)
    - 数据链路层中继系统：网桥或桥接器 (bridge)
    - 网络层中继系统：路由器 (router)
    - 网桥和路由器的混合物：桥路器 (brouter)
    - 网络层以上的中继系统：网关 (gateway)

当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。

网络互连都是指用路由器进行网络互连和路由选择。由于历史的原因，许多有关 TCP/IP的文献将网络层使用的路由器称为网关。网关由于比较复杂，目前使用得较少。

- 互连网络与虚拟互连网络：互联网由多种异构互连网络互连组成

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220164437578.png" alt="image-20201220164437578" style="zoom:50%;" />

  所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

  使用 IP协议的虚拟互连网络可简称为 IP网。

  使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。如果在这种覆盖全球的 IP网的上层使用 TCP协议，那么就是现在的互联网(Internet)。

#### 2.2、分类的IP地址

IP地址：给每个连接在互联网上的主机 (或路由器) 分配一个在全世界范围是唯一的 32位的标识符

IP地址的编址方法：

- 分类的IP地址——本节只讨论最基本的分类的 IP地址

- 子网的划分

- 构成超网

分类的IP地址：将IP地址划分为若干个固定类。每一类地址都由两个固定长度的字段组成，其中一个字段是网络号net-id，它标志主机(或路由器)所连接到的网络，而另一个字段则是主机号host-id，它标志该主机 (或路由器)。主机号在它前面的网络号所指明的网络范围内必须是唯一的。

由此可见，一个IP地址在整个互联网范围内是唯一的

- 这种两级的 IP地址可以记为：**==IP 地址 ::= { <网络号>, <主机号>}==**（**::=**  代表“定义为”）

各类IP地址的网络号字段和主机号字段：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220171341334.png" alt="image-20201220171341334" style="zoom: 50%;" />

- A类、B类和C类地址的网络号字段（在图中这个字段是灰色的）分别为1个、2个和3个字节长，而在网络号字段的最前面有1~3位的类别位，其数值分别规定为0，10和110，通过前几位的数值可推断地址类别
- A类、B类和C类地址的主机号字段分别为3个、2个和1个字节长
- D类地址（前4位是1110）用于多播(一对多通信)。我们将在4.6节讨论IP多播。E类地址（前4位是1111）保留为以后用。

点分十进制记法：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220172254847.png" alt="点分十进制记法" style="zoom:67%;" />

> 点分十进制记法举例：
>
> |                32位二进制数                 | 等价的点分十进制数 | 网络类别 |
> | :-----------------------------------------: | :----------------: | :------: |
> | ==10==000001 00110100 **00000110 00000000** |     129.52.6.0     |   B类    |
> | ==110==00000 00000101 00110000 **00000011** |     192.5.48.3     |   C类    |
> | ==0==0001010 **00000010 00000000 00100101** |     10.2.0.37      |   A类    |
> | ==10==000000 00001010 **00000010 00000011** |     128.10.2.3     |   B类    |
> | ==10==000000 10000000 **11111111 00000000** |   128.128.255.0    |   B类    |

IP地址的指派范围：

| 网络类别 | 最大可指派的网络数  | 第一个可指派的网络号 | 最后一个可指派的网络号 | 每个网络中最大主机数  |
| :------: | :-----------------: | :------------------: | :--------------------: | :-------------------: |
|    A     |   126 (2^7^ – 2)    |          1           |          126           | 16777214 (2^24^  – 2) |
|    B     |  16383 (2^14^ – 1)  |        128.1         |        191.255         |   65534 (2^16^ – 2)   |
|    C     | 2097151 (2^21^ – 1) |       192.0.1        |      223.255.255       |    254 (2^8^ – 2)     |

IP地址的一些重要特点：

1. IP地址是一种分等级的地址结构。分两个等级的好处是：

   - IP地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样方便了IP地址的管理

   - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间

2. 实际上 IP地址是标志一个主机（或路由器）和一条链路的接口

   - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id必须是不同的。这种主机称为多归属主机 (multihomed host)

   - 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP地址**

3. **用转发器或网桥连接起来的若干个局域网仍为一个网络**，因此这些局域网都具有同样的网络号net-id

4. 所有分配到网络号 net-id的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的

#### 2.3、IP地址与MAC硬件地址

MAC硬件地址是数据链路层和物理层使用的地址

IP地址是网络层和以上各层使用的地址，是一种逻辑地址（称 IP地址是逻辑地址是因为 IP地址是用软件实现的）

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220182119117.png" alt="image-20201220182119117" style="zoom: 50%;" />

IP地址放在 IP数据报的首部，而硬件地址则放在 MAC 帧的首部，在数据链路层，IP数据报封装在MAC帧中

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220184042772.png" alt="image-20201220184042772" style="zoom:50%;" />

一个主机和另一个主机通信，不断地经由路由器转发，从数据链路层上看 MAC帧是不断变化的，只能看见 MAC帧而看不见IP数据报。而从网络层来看IP数据报是不变的。

- 主机H1与 H2通信中使用的IP地址与硬件地址HA：

  |             | 在网络层写入IP数据报首部的地址 | 在数据链路层写入MAC帧首部的地址 |        |          |
  | :---------: | :----------------------------: | :-----------------------------: | :----: | :------: |
  |             |             源地址             |            目的地址             | 源地址 | 目的地址 |
  | 从 H1 到 R1 |              IP1               |               IP2               |  HA1   |   HA3    |
  | 从 R1 到 R2 |              IP1               |               IP2               |  HA4   |   HA5    |
  | 从 R2 到 H2 |              IP1               |               IP2               |  HA6   |   HA2    |

#### 2.4、地址解析协议ARP

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220185551528.png" alt="image-20201220185551528" style="zoom:50%;" />

地址解析协议ARP(Address Resolution Protocol) 的作用：从网络层使用的IP地址，解析出在数据链路层使用的硬件地址。

地址解析协议 ARP 要点：

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

每一个主机都设有一个 ARP高速缓存 (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP地址到硬件地址的映射表：

**< IP address；MAC address；TTL >** (TTL (Time To Live)：地址映射有效时间 )

例：当主机A 欲向本局域网上的某个主机B 发送 IP数据报时，就先在其 ARP 高速缓存中查看有无主机B 的 IP地址。

- 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC帧，然后通过局域网将该 MAC帧发往此硬件地址。

- 如没有， 主机A就自动运行ARP，在本局域网上广播发送一个ARP请求分组。收到 ARP响应分组后，将得到的 IP地址到硬件地址的映射写入ARP高速缓存

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220191857163.png" alt="image-20201220191857163" style="zoom:50%;" />

  1. ARP进程在本局域网上广播发送一个ARP请求分组
  2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组
  3. 主机B 的 IP地址与 ARP请求分组中要查询的 IP地址一致，就收下这个 ARP请求分组，并向主机A 发送 ARP响应分组，同时在这ARP响应分组中写入自己的硬件地址

- ARP高速缓存的作用：
  - 存放最近获得的 IP地址到MAC地址的绑定，以减少ARP广播的数量
  - 为了减少网络上的通信量，主机 A在发送其 ARP请求分组时，就将自己的 IP地址到硬件地址的映射写入 ARP请求分组
  - 当主机B 收到 A的 ARP请求分组时，就将主机A 的这一地址映射写入主机B 自己的 ARP高速缓存中。这对主机B 以后向 A发送数据报时就更方便了

**应当注意的问题**：

- **ARP是解决同一个局域网上的主机或路由器的 IP地址和硬件地址的映射问题**
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做
- **从 IP 地址到硬件地址的解析是自动进行的**，主机的用户对这种地址解析过程是不知道的
- 只要主机或路由器要和本网络上的另一个已知 IP地址的主机或路由器进行通信，ARP协议就会自动地将该 IP地址解析为链路层所需要的硬件地址

使用ARP的四种典型情况：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201220192954351.png" alt="image-20201220192954351" style="zoom:50%;" />

1. 发送方是主机，要把 IP数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址
2. 发送方是主机，要把 IP数据报发送到另一个网络上的一个主机。这时用ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成
3. 发送方是路由器，要把 IP数据报转发到本网络上的一个主机。这时用ARP 找到目的主机的硬件地址
4. 发送方是路由器，要把 IP数据报转发到另一个网络上的一个主机。这时用ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成

> **为什么不直接使用硬件地址进行通信？**
>
> 由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。
>
> IP编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的 IP地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。
>
> 因此，在虚拟的 IP网络上用 IP地址进行通信给广大的计算机用户带来了很大的方便。

#### 2.5、IP数据报的格式

一个 IP 数据报由首部和数据两部分组成。**首部的前一部分一般是固定长度，共 20字节，是所有 IP数据报必须具有的**。在首部的固定部分的后面可能有一些可选字段，其长度是可变的。下图固定部分中一行4字节

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201222105205819.png" alt="image-20201222105205819" style="zoom:50%;" />

- 版本：占4位，指 IP协议的版本。目前的 IP协议版本号为4 (即 IPv4)

- 首部长度：占4位，可表示的最大数值，是 15个单位(一个单位为 4字节)，因此 IP 的首部长度的最大值是 60字节，得出可选字段最大长度是40个字节

- 区分服务：占8位，用来获得更好的服务

- 总长度：占16位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 2<sup>16</sup>-1=65535字节。总长度必须不超过最大传送单元MTU（通常是1500字节）

- 标识(identification) ：占 16位，它是一个计数器，用来产生 IP数据报的标识

- 标志(flag) ：占3位，目前只有两位有意义，剩余一位保留。标志字段的最低位是MF(More Fragment)。MF=1表示后面“还有分片”。MF=0 表示最后一个分片。标志字段中间的一位是DF(Don't Fragment) 。只有当 DF=0 时才允许分片

- 片偏移：占13位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8个字节为偏移单位

  > IP数据报分片：
  >
  > 一数据报的总长度为 3820字节，其数据部分的长度为 3800字节（使用固定首部），需要分片为长度不超过 1420字节的数据报片。因固定首部长度为 20字节，因此每个数据报片的数据部分长度不能超过 1400字节。
  >
  > <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223172916460.png" alt="image-20201223172916460" style="zoom:50%;" />
  >
  > 于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。
  >
  > 原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值

- 生存时间：占8 位，记为TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值

- 协议：占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP层将数据部分上交给哪个协议处理

- 首部检验和：占16位，只检验数据报的首部，不检验数据部分。这里不采用 CRC检验码而采用简单的计算方法

- 源地址和目的地址都各占 4字节

- IP 数据报首部的可变部分：
  
  - IP首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。选项字段的长度可变，从 1个字节到 40个字节不等，取决于所选择的项目。增加首部的可变部分是为了增加 IP数据报的功能，但这同时也使得 IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。==实际上这些选项很少被使用==

#### 2.6、IP层转发分组的流程

在路由表中，对于每一条路由，最主要的是(目的网络地址，下一跳地址) 。路由器根据目的网络地址来确定下一跳路由器，这样做的结果是：

- IP数据报最终一定可以找到目的主机所在目的网络上的路由器(可能要通过多次的间接交付)
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付

必须强调指出：

- IP数据报的首部中没有地方可以用来指明“下一跳路由器的 IP地址”
- 当路由器收到待转发的数据报，不是将下一跳路由器的 IP地址填入 IP数据报，而是送交下层(数据链路层)的网络接口软件
- 网络接口软件使用 ARP负责将下一跳路由器的 IP地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器

**路由器分组转发算法：**

1. 从数据报的首部提取目的主机的 IP地址D, 得出目的网络地址为N
2. 若网络N 与此路由器直接相连，则把数据报直接交付目的主机D；否则是间接交付，执行3
3. 若路由表中有目的地址为D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行4
4. 若路由表中有到达网络N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行5
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行6
6. 报告转发分组出错

### 3、划分子网和构造超网

#### 3.1、划分子网

**1）从两级IP地址到三级IP地址**

在 ARPANET的早期，IP地址的设计确实不够合理：

1. IP地址空间的利用率有时很低
2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏
3. 两级的 IP地址不够灵活

**2）三级IP地址** 

划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。

==划分子网的方法：从主机号借用若干个位作为子网号subnet-id，而主机号host-id 也就相应减少了若干个位==

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223222936674.png" alt="image-20201223222936674" style="zoom:50%;" />

划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络

由于划分子网的子网号是可变的，怎样区别划分的子网号和主机号成了一个问题

**3）子网掩码**

从一个 IP数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码 (subnet mask)可以找出 IP地址中的子网部分。 变长子网掩码VLSM (Variable Length Subnet Mask)可进一步提高 IP地址资源的利用率

- 规则：

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223224825996.png" alt="image-20201223224825996" style="zoom:50%;" />

  - 子网掩码长度＝32位
  - 某位＝1：IP地址中的对应位为网络号和子网号
  - 某位＝0：IP地址中的对应位为主机号 

- **(IP地址) AND (子网掩码) = 子网的网络地址** (因为二进制运算中 x AND 1 = x)

子网掩码是一个网络或一个子网的重要属性。

路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

- 子网划分方法：
  - 固定长度子网划分：所划分的所有子网的子网掩码都是相同的
  - 变长子网划分：所划分的子网的子网掩码都是不同的

> 例：已知 IP地址是141.14.72.24，子网掩码是 255.255.192.0。试求网络地址
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201223230735134.png" alt="image-20201223230735134" style="zoom:50%;" />
>
> 子网掩码为 255.255.255.0 代表什么意思？可以连接多少位主机
>
> 此子网掩码网络号和子网号总共占24位，主机位占8位。可以连 2<sup>8</sup> 个主机

#### 3.2、使用子网时分组的转发

在不划分子网的两级 IP地址下，从 IP地址得出网络地址是个很简单的事。但在划分子网的情况下，从 IP地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息。因此分组转发的算法也必须做相应的改动。

在划分子网情况下路由器转发分组的算法：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224090437542.png" alt="image-20201224090437542" style="zoom:50%;" />

路由器的路由表相比之前增加了子网掩码

1. 从收到的分组的首部提取目的 IP地址D
2. 先用各网络的子网掩码和 D逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行3
3. 若路由表中有目的地址为 D的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行4
4. 对路由表中的每一行，将子网掩码和 D逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则执行5
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则执行6
6. 报告转发分组出错

#### 3.3、无分类编址CIDR(构造超网)

无分类域间路由选择CIDR (Classless Inter-Domain Routing)消除了传统的 A类、B类和 C类地址以及划分子网的概念，因而可以更加有效地分配 IPv4的地址空间。

**1）网络前缀**：CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。IP地址从三级编址(使用子网掩码)又回到了两级编址。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224101753998.png" alt="image-20201224101753998" style="zoom:50%;" />

CIDR使用“斜线记法”(slash notation)，它又称为 CIDR记法，即在 IP地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1的个数）。例如： 220.78.168.0/24

CIDR地址块：CIDR把网络前缀都相同的连续的 IP地址组成“CIDR地址块”

> 128.14.32.0/20表示的地址块共有 212个地址（因为斜线后面的20 是网络前缀的位数，所以这个地址的主机号是 12位）。这个地址块的起始地址是 128.14.32.0。在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”
>
> 128.14.32.0/20 地址块的最小地址：128.14.32.0；128.14.32.0/20 地址块的最大地址：128.14.47.255。全 0 和全 1 的主机号地址一般不使用

路由聚合(route aggregation)：一个 CIDR地址块可以表示很多地址，这种地址的聚合常常称为路由聚合。也称为构造超网。

- 它使得路由表中的一个项目可以表示很多个 (例如上千个) 原来传统分类地址的路由。路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能

构成超网：

- 前缀长度不超过 23位的 CIDR地址块都包含了多个C类地址。这些C类地址合起来就构成了超网
- CIDR地址块中的地址数一定是 2的整数次幂
- 网络前缀越短，其地址块所包含的地址数就越多。而在三级结构的 IP地址中，划分子网是使网络前缀变长
- CIDR的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR地址块

**2）最长前缀匹配**

使用CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。

应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配 (longest-prefix matching)。网络前缀越长，其地址块就越小，因而路由就越具体 (more specific) 。最长前缀匹配又称为最长匹配或最佳匹配

### 4、网际控制报文协议ICMP

为了提高 IР数据报交付成功的机会。在网际层使用了网际控制报文协议ICMP (lnternet Control Message Protocol)。
ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。ICMP不是高层协议，而是IP层的协议。

ICMP报文作为 IP层 IP数据报的数据。IP加上数据报的首部，组成 IР数据报发送出去。

- ICMP报文格式

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224105113402.png" alt="image-20201224105113402" style="zoom:50%;" />

  ICMP报文的前 4个字节是统一的格式。共有三个字段：类型、代码和检验和。接着的4个字节的内容与 ICMP的类型有关。


#### 4.1、ICMP报文的种类

ICMP报文种类：

- ICMP差错报告报文有5种：
  - 终点不可达：路由器或主机不能交付数据报时就向源点发送终点不可达报文
  - 时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文
  - 参数问题：路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文
  - 改变路由(重定向) (Redi rect)：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）

- ICMP差错报告报文的数据字段的内容

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224110904437.png" alt="image-20201224110904437" style="zoom:50%;" />

  B接受到 A 发送 IP数据报后，把收到的需要进行差错报告的 IP数据报的首部和数据字段的前8个字节提取出来，再加上相应的 ICMP差错报告报文的前 8个字节，组成 ICMP差错报告报文，再将差错报告报文封装成 IP数据报往源地址A 返回，ICMP前 8字节里说明目标是不可到达、请求超时等错误信息

- 不应发送ICMP差错报告报文的几种情况：
  1. 对ICMP差错报告报文不再发送 ICMP差错报告报文
  2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP差错报告报文
  3. 对具有多播地址的数据报都不发送 ICMP差错报告报文
  4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP差错报告报文

- ICMP询问报文：
  - 回送请求和回答报文：ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
  - 时间戳请求和回答报文：ICMP时间戳请求报文是请某台主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻有多少秒。时间戳请求与回答可用于时钟同步和时间测量。

#### 4.2、ICMP的应用举例

- PING(Packet InterNet Groper) ：用来测试两个主机之间的连通性

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224123726165.png" alt="image-20201224123726165" style="zoom: 67%;" />

  - PING 使用了 ICMP回送请求与回送回答报文
  - PING 是应用层直接使用网络层ICMP 的例子，它没有通过运输层的 TCP或UDP

- Traceroute的应用：用来跟踪一个分组从源点到终点的路径

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201224124214986.png" alt="image-20201224124214986" style="zoom:67%;" />

  - 在 Windows操作系统中这个命令是tracert
  - 它利用 IP数据报中的 TTL字段和 ICMP时间超过差错报告报文实现对从源点到终点的路径的跟踪

### 5、互联网的路由选择协议

#### 5.1、有关路由选择协议的几个基本概念

##### 1）理想的路由算法

路由选择协议的核心就是路由算法，即需要何种算法来获得路由表中的各项目。理想的路由算法应具有如下的特点：

1. 算法必须是正确的和完整的
2. 算法在计算上应简单
3. 算法应能适应通信量和网络拓扑的变化，即要有自适应性
4. 算法应具有稳定性
5. 算法应是公平的
6. 算法应是最佳的

从路由算法能否随网络的通信量或拓扑自适应地进行调整变化来划分：

- 静态路由选择策略——非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。

- 动态路由选择策略——自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大

##### 2）分层次的路由选择协议

互联网采用==分层次的路由选择协议==，这是因为：

1. 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和
2. 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上

自治系统AS(Autonomous System) ：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS内部的路由选择协议和共同的度量以确定分组在该 AS内的路由，同时还使用一种 AS之间的路由选择协议用以确定分组在 AS之间的路由。一个 AS对其他AS 表现出的是一个单一的和一致的路由选择策略。

互联网就把路由选择协议划分为两大类：

- 内部网关协议IGP(Interior Gateway Protocol)：即在一个自治系统内部使用的路由选择协议，而这与在互联网中的其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP和 OSPF协议。
- 外部网关协议EGP(External Gateway Protocol) ：若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议EGP。

#### 5.2、内部网关协议RIP

RIP(Routing Information Protocol)路由信息协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录

- “距离”的定义：从一个路由器到直接连接的网络的距离定义为1
  - 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加1
  - RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加1
  - 这里的“距离”实际上指的是“最短距离”

RIP认为一个好的路由就是它通过的路由器的数目少，即“距离短”。RIP允许一条路径最多只能包含 15个路由器。“距离”的最大值为16时，即相当于不可达。可见RIP只适用于小型互联网。

RIP不能在两个网络之间同时使用多条路由。RIP选择一个具有最少路由器的路由(即最短路由)，哪怕还存在另一条高速(低时延)但路由器较多的路由

- RIP协议的特点：

  - 仅和相邻路由器交换信息
  - 路由器交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表

    - 路由表中的信息是：目的网络、到某个网络的距离 (即最短距离) 以及应经过的下一跳地址。路由表更新的原则是找出到每个目的网络的最短距离。这种更新算法又称为距离向量算法
    - RIP协议根据跳数选择最佳路径，经过路由器越少路径最优（最大跳数16）
- 按固定的时间间隔(如每隔30s)周期性地广播自己知道的网段给其他路由器，当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息

路由表的建立：

- 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）。它的路由表是空的。以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
- RIP协议的**收敛 (convergence)** 程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程

> 例1：已知路由器R6有下表所示的路由表。现在收到相邻路由器 R4发来的路由更新信息，如下表所示。试更新路由器R6的路由表
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225090012398.png" alt="image-20201225090012398" style="zoom:50%;" />
>
> Net1：以前没有，添加到路由表
> Net2：相同下一跳路由，更新路由表
> Net3：不同下一跳路由，更新路由表
>
> 例2：路由表更新
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225091537061.png" alt="image-20201225091537061" style="zoom: 67%;" />

RIP协议的优缺点：

- 优点：实现简单，开销较小
- 缺点：
  - RIP 限制了网络的规模，它能使用的最大距离为15（16表示不可达）
  - 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加
  - “坏消息传播得慢”，使更新过程的收敛时间过长

#### 5.3、内部网关协议OSPF

开放最短路径优先OSPF(Open Shortest Path First)使用了 Dijkstra提出的最短路径算法SPF，采用分布式的链路状态协议(link state protocol)

- OSPF协议的特点：

  1. 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法

  2. 发送的信息就是与本路由器相邻的所有路由器的链路状态。但这只是路由器所知道的部分信息

  3. 只有当链路状态发生变化时。路由器才用洪泛法向所有路由器发送此信息

- 链路状态数据库(link-state database)：

  - 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）
  - OSPF的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。OSPF的更新过程收敛得快是其重要优点

- OSPF的区域(area)：

  - 为了使 OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个 32位的区域标识符（用点分十进制表示）
  - 区域也不能太大，在一个区域内的路由器最好不超过 200个

OSPF还规定每隔一段时间，如30分钟，要刷新一次数据库中的链路状态。

由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量协议RIP 好得多。 

OSPF没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于100ms

#### 5.4、外部网关协议BGP

**BGP是不同 AS自治系统的路由器之间交换路由信息的协议。**
边界网关协议BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。
每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP发言人

*一个 BGP发言人与其他自治系统中的  BGP发言人要交换路由信息，就要先建立 TCP连接，然后在此连接上交换BGP报文以建立  BGP会话(session)，利用  BGP会话交换路由信息。*

- BGP协议的特点：

	- BGP协议支持CIDR（变长子网）
	- 在 BGP刚刚运行时，BGP的邻站是交换整个的 BGP路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处
	- BGP协议交换路由信息的结点数量级是自治系统的数量级，这要比这些自治系统中的网络数少很多
	- 每一个自治系统中 BGP发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂

#### 5.5、路由器的构成

路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。从路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。

路由器是一种典型的网络层设备。路由器是互联网中的关键设备。

- 路由器的主要作用是：
  - 连通不同的网络
  - 选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来

整个的路由器结构可划分为两大部分：

- 路由选择部分：也叫做控制部分，其核心构件是路由选择处理机
  - 路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表

- 分组转发部分，由三部分组成：
  - 交换结构 (switching fabric)：又称为交换组织，其作用是根据转发表 (forwarding table) 对分组进行处理
  - 一组输入端口
  - 一组输出端口（请注意：这里的端口就是硬件接口）

### 6、IPv6

解决IPV4地址耗尽的根本措施就是采用具有更大地址空间的新版本的IP，即IPv6

#### 6.1、IPv6的基本首部

IPv6仍支持无连接的传送，但将协议数据单元 PDU称为分组。为方便起见，本书仍采用数据报这一名词。

所引进的主要变化如下：

- 更大的地址空间。IPv6将地址从 IPv4 的 32位 增大到了 128位
- 扩展的地址层次结构
- 灵活的首部格式。 IPv6定义了许多可选的扩展首部
- 改进的选项。 IPv6允许数据报包含有选项的控制信息，其选项放在有效载荷中
- 允许协议继续扩充
- 支持即插即用（即自动配置）。因此IPv6不需要使用DHCP
- 支持资源的预分配。 IPv6支持实时视像等要求，保证一定的带宽和时延的应用
- IPv6首部改为8字节对齐。首部长度必须是 8 字节的整数倍。原来的IPv4首部是4字节对齐

IPv6数据报的一般形式：两大部分组成：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225134344352.png" alt="image-20201225134344352" style="zoom:50%;" />

- 基本首部 (base header)：IPv6基本首部长度变为固定的40字节

- 有效载荷 (payload)：也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225133938624.png" alt="image-20201225133938624" style="zoom:50%;" />

- 版本(version)：4位。它指明了协议的版本，对IPv6该字段总是6
- 通信量类(traffic class)：8位。这是为了区分不同的IPv6数据报的类别或优先级。目前正在进行不同的通信量类性能的实验
- 流标号(flow label)：20位。 “流”是互联网络上从特定源点到特定终点的一系列数据报， “流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号
- 有效载荷长度(payload length)：16位。它指明IPv6数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是64KB
- 下一个首部(next header)：8位。它相当于IPv4的协议字段或可选字段
- 跳数限制(hop limit)：8位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减1。当跳数限制的值为零时，就要将此数据报丢弃
- 源地址：128位。是数据报的发送站的IP地址
- 目的地址：128位。是数据报的接收站的IP地址

IPv6的扩展首部：IPv6把原来IPv4首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理。数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部）。这样就大大提高了路由器的处理效率

#### 6.2、IPv6的地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. 单播 (unicast)：传统的点对点通信
2. 多播 (multicast)：一点对多点的通信
3. 任播 (anycast)：IPv6增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个

冒号十六进制记法：

在 IPv6中，每个地址占 128位，地址空间大于 3.4×10<sup>38</sup> 。

为了使地址再稍简洁些，IPv6使用冒号十六进制记法(colon hexadecimal notation, 简写为 colon hex)。

每个16位的值用十六进制值表示，各值之间用冒号分隔。例如：68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF，在十六进制记法中，允许把数字前面的 0省略。例如把 0000中的前三个0 省略，写成 1个0

#### 6.3、从IPv4向IPv6过渡

向IPv6过渡只能采用逐步演进的办法，同时，还必须使新安装的IPv6系统能够向后兼容：IPv6系统必须能够接收和转发 IPv4分组，并且能够为 IPv4分组选择路由。

两种向 IPv6 过渡的策略：

- 使用双协议栈：指在完全过渡到 IPv6之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4和一个IPv6
  - 双协议栈主机在和 IPv6主机通信时是采用 IPv6地址，而和 IPv4主机通信时就采用 IPv4地址
  - 根据 DNS域名系统返回的地址类型可以确定使用 IPv4地址还是 IPv6地址
- 使用隧道技术：
  - 在 IPv6数据报要进入 IPv4网络时，把 IPv6数据报封装成为 IPv4数据报，整个的 IPv6数据报变成了 IPv4数据报的数据部分
  - 当 IPv4数据报离开 IPv4网络中的隧道时，再把数据部分（即原来的 IPv6数据报）交给主机的 IPv6协议栈

#### 6.4、ICMPv6

IPv6也不保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报。因此 IPv6也需要使用 ICMP来反馈一些差错信息。新的版本称为 ICMPv6。CMPv6是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站或管理多播通信。

### 7、IP多播

IP多播 (multicast，以前曾译为组播) 已成为互联网的一个热门课题。目的：更好第支持一对多通信。

一对多通信：一个源点发送到许多个终点。如实时信息的交付（如新闻、股市行情等），软件更新，交互式会议及其他多媒体通信

多播可大大节约网络资源：

- 采用单播方式，向90台主机传送同样的视频节目需要发送90个单播
- 采用多播方式，只需发送一次到多播组。路由器复制分组。局域网具有硬件多播功能，不需要复制分组

在互联网上进行多播就叫做 IP多播。互联网范围的多播要靠路由器来实现。能够运行多播协议的路由器称为多播路由器(multicast router)。当然它也可以转发普通的单播IP数据报。

### 8、虚拟专用网VPN和网络地址转换NAT

#### 8.1、虚拟专用网VPN

由于 IP地址的紧缺，一个机构能够申请到的 IP地址数往往远小于本机构所拥有的主机数。考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。

假定在一个机构内部的计算机通信也是采用 TCP/IP协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP地址。让这些计算机使用仅在本机构有效的 IP地址（这种地址称为本地地址），而不需要向互联网的管理机构申请全球唯一的 IP 地址(这种地址称为全球地址)。

RFC1918指明了一些专用地址(private address) 。这些地址只能于一个机构的内部通信，而不能用于和互联网上的主机通信。即专用地址只能用做本地地址而不能用作全球地址。**在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发**。

专用网：采用这样的专用 IP地址的互连网络称为专用互联网或本地互联网。因为这些专用地址仅在本机构内部使用。专用 IP地址也叫做可重用地址(reusable address)。

虚拟专用网VPN(Virtual Private Network)：利用公用的互联网作为本机构各专用网之间的通信载体的专用网又称为虚拟专用网VPN。

“专用网”是因为这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。

“虚拟”表示“好像是”，但实际上并不是，因为现在并没有真正使用通信专线，而VPN只是在效果上和真正的专用网一样。

- **用隧道技术实现虚拟专用网**：

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225170348302.png" alt="image-20201225170348302" style="zoom:67%;" />

  所谓的隧道其实就是封装。A对 B发送数据时，把部门A 要发送的网络数据进行封装，将其伪装成一个普通的数据发送到部门B，在封装的过程中还可以对数据进行加密处理 (不同的VPN加密方式不相同) 。封装后数据就可以在互联网上发送，B获取数据后，若打开用VPN技术封装的数据是可信任的数据，就接收。

#### 8.2、网络地址转换NAT

问题：在专用网上使用专用地址的主机如何与互联网上的主机通信（并不需要加密）？

- 解决： 
  1. 再申请一些全球 IP地址。但这在很多情况下是不容易做到的
  2. 采用网络地址转换NAT。这是目前使用得最多的方法

网络地址转换NAT(Network Address Translation)：需要在专用网连接到互联网的路由器上安装 NAT软件。装有 NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球 IP地址。所有使用本地地址的主机在和外界通信时，**NAT路由器将其本地地址转换成全球IP地址，才能和互联网连接。**

### 9、多协议标记交换MPLS

多协议标记交换MPLS(MultiProtocol Label Switching)：

- “多协议”表示在 MPLS的上层可以采用多种协议，如IP，IPX；可以使用多种数据链路层协议，如PPP，以太网，ATM等
- “标记”是指每个分组被打上一个标记，根据该标记对分组进行转发

为了实现交换，可以利用面向连接的概念，使每个分组携带一个叫做标记 (label) 的小整数。当分组到达交换机(即标记交换路由器)时，交换机读取分组的标记，并用标记值来检索分组转发表。 这样就比查找路由表来转发分组要快得多。

MPLS并没有取代IP，而是作为一种 IP增强技术，被广泛地应用在互联网中。

- MPLS具有以下三个方面的特点：
  - 支持面向连接的服务质量
  - 支持流量工程，平衡网络负载
  - 有效地支持虚拟专用网VPN

## 第五章 运输层

运输层为相互通信的应用进程提供了逻辑通信。

### 1、运输层协议概述

#### 1.1、进程之间的通信

从通信和信息处理的角度看，**运输层向它上面的应用层提供通信服务**，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，**只有位于网络边缘部分的主机的协议栈才有运输层**，而网络核心部分中的路由器在转发分组时都只用到下三层的功能。

“逻辑通信”的意思是“好像是这样通信，但事实上并非真的这样通信”。从 IP层来说，通信的两端是两台主机。但“两台主机之间的通信”这种说法还不够清楚。严格地讲，两台主机进行通信就是两台主机中的应用进程互相通信。

从运输层的角度看，通信的真正端点并不是主机而是主机中的进程。也就是说，**端到端的通信是应用进程之间的通信**。

网络层和运输层有明显的区别：**网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信。**

在一台主机中经常有多个应用进程同时分别和另一台主机中的多个应用进程通信。这表明运输层有一个很重要的功能：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225175529230.png" alt="image-20201225175529230" style="zoom:50%;" />

- 复用(multiplexing)：指在发送方不同的应用进程都可以使用同一个运输层协议传送数据（当然需要加上适当的首部）
- 分用(demultiplexing)：指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225175836702.png" alt="image-20201225175836702" style="zoom:67%;" />

屏蔽作用：运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就是好像在两个运输层实体之间有一条端到端的逻辑通信信道。

两种不同的运输协议：根据应用程序的不同需求，运输层需要有两种不同的运输协议，即面向连接的 TCP和无连接的 UDP。

- 当运输层采用面向连接的 TCP协议时，尽管下面的网络是不可靠的(只提供尽最大努力服务)，但这种逻辑通信信道就相当于一条全双工的可靠信道
- 当运输层采用无连接的 UDP协议时，这种逻辑通信信道是一条不可靠信道

#### 1.2、运输层的两个主要协议

用户数据报协议UDP(User Datagram Protocol)；传输控制协议TCP(Transmission Control Protocol)

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201225180748227.png" alt="image-20201225180748227" style="zoom: 50%;" />

两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元TPDU(Transport Protocol Data Unit)。TCP传送的数据单位协议是 TCP报文段(segment)。UDP传送的数据单位协议是 UDP报文或用户数据报。

- UDP：一种无连接协议，提供无连接服务
  - 在传送数据之前不需要先建立连接
  - 传送的数据单位协议是UDP报文或用户数据报
  - 对方的运输层在收到UDP报文后，不需要给出任何确认
  - 虽然UDP不提供可靠交付，但在某些情况下UDP是一种最有效的工作方式。如直播、视屏通话
- TCP：一种面向连接的协议，提供面向连接的服务
  - 传送的数据单位协议是TCP报文段(segment)
  - TCP不提供广播或多播服务
  - 由于TCP要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源

**强调两点：**

- 运输层的 UDP用户数据报与网际层的IP数据报有很大区别：
  - IP数据报要经过互连网中许多路由器的存储转发
  - UDP用户数据报是在运输层的端到端抽象的逻辑信道中传送的

- TCP报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道。但这样的信道却不知道究竟经过了哪些路由器，而这些路由器也根本不知道上面的运输层是否建立了 TCP连接

#### 1.3、运输层的端口

**运行在计算机中的进程是用进程标识符来标志的**。**但运行在应用层的各种应用进程却不应当让计算机操作系统指派它的进程标识符**。这是因为在互联网上使用的计算机的操作系统种类很多，而不同的操作系统又使用不同格式的进程标识符。

为了使运行不同操作系统的计算机的应用进程能够互相通信，就必须用统一的方法对 TCP/IP体系的应用进程进行标志。

协议端口号(protocol port number)，或通常简称为端口(port)。虽然通信的终点是应用进程，但我们可以把端口想象是通信的终点，因为我们只要把要传送的报文交到目的主机的某一个合适的目的端口，剩下的工作（即最后交付目的进程）就由 TCP来完成。

- 软件端口：在协议栈层间的抽象的协议端口

- 硬件端口：路由器或交换机上的端口

  硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址

TCP/IP运输层端口：用一个16位端口号进行标志，所以数量有2<sup>16</sup>个

- 端口号只具有本地意义，即端口号只是为了标志本计算机应用层中的各进程

- 在互联网中，不同计算机的相同端口号是没有联系的

  由此可见，两个计算机中的进程要互相通信，不仅必须知道对方的IP地址 (为了找到对方的计算机) ，而且还要知道对方的端口号(为了找到对方计算机中的应用进程)

**两大类端口**：

1. 服务器端使用的端口号：
   - 熟知端口，数值一般为0~1023
   - 登记端口号，数值为1024~49151，为没有熟知端口号的应用程序使用的。使用这个范围的端口号必须在 IANA登记，以防止重复

2. 客户端使用的端口号：又称为短暂端口号，数值为49152~65535，留给客户进程选择暂时使用。

当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。

### 2、用户数据报协议UDP 

#### 2.1、UDP 概述

UDP只在 IP的数据报服务之上增加了很少一点的功能：复用和分用的功能、差错检测的功能。虽然 UDP用户数据报只能提供不可靠的交付，但 UDP在某些方面有其特殊的优点：

1. UDP是无连接的，发送数据之前不需要建立连接，，因此减少了开销和发送数据之前的时延
2. UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表
3. UDP是面向报文的。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。UDP一次交付一个完整的报文
4. UDP没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。很适合多媒体通信的要求
5. UDP支持一对一、一对多、多对一和多对多的交互通信
6. UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短

发送方UDP对应用程序交下来的报文，在添加首部后就向下交付IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。**应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文**。

接收方 UDP对 IP层交上来的 UDP用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文。

应用程序必须选择合适大小的报文：

- 若报文太长，UDP把它交给 IP层后，IP层在传送时可能要进行分片，这会降低 IP层的效率
- 若报文太短，UDP把它交给 IP层后，会使IP数据报的首部的相对长度太大，这也降低了 IP层的效率

#### 2.2、UDP 的首部格式

用户数据报UDP有两个字段：数据字段和首部字段。首部字段很简单，只有8个字节。由四个字段组成，每个字段的长度都是两个字节。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226135238864.png" alt="image-20201226135238864" style="zoom: 50%;" />

1. 源端口：源端口号。在需要对方回信时选用。不需要时可用全0
2. 目的端口：目的端口号。这在终点交付报文时必须使用
3. 长度：UDP用户数据报的长度，其最小值是8(仅有首部)
4. 检验和：检测UDP用户数据报在传输中是否有错。有错就丢弃

在计算检验和时，临时把“伪首部”和 UDP用户数据报连接在一起。伪首部仅仅是为了计算检验和，计算完成后丢弃伪首部

### 3、传输控制协议TCP概述

#### 3.1、TCP 最主要的特点

1. TCP是面向连接的运输层协议。每一条 TCP连接只能有两个端点(endpoint)，且只能是点对点的（一对一）。

2. TCP提供可靠交付的服务。

3. TCP提供全双工通信。

4. 面向字节流：TCP中的“流”(stream) 指的是流入或流出进程的字节序列。
   - “面向字节流”的含义是：虽然应用程序和TCP的交互是一次一个数据块，但 TCP把应用程序交下来的数据看成仅仅是一连串无结构的字节流
     - TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系。但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样

**注 意：**

- TCP连接是**一条虚连接而不是一条真正的物理连接**
- TCP对应用进程一次把多长的报文发送到 TCP的缓存中是不关心的
- TCP根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP发送的报文长度是应用进程给出的）
- TCP可把太长的数据块划分短一些再传送
- TCP也可等待积累有足够多的字节后再构成报文段发送出去

#### 3.2、TCP 的连接

TCP把连接作为最基本的抽象。每一条TCP连接有两个端点。

TCP连接的端点不是主机，不是主机的 IP地址，不是应用进程，也不是运输层的协议端口。TCP连接的端点叫做套接字(socket)或插口。

端口号拼接到 (contatenated with) IP地址即构成了套接字。套接字的表示方法是在点分十进制的IP地址后面写上端口号，中间用冒号或逗号隔开。例如，若IP地址是 192.3.4.5 而端口号是80，那么得到的套接字就是(192.3.4.5: 80)

**套接字 socket = (IP地址 : 端口号)**

每一条 TCP连接唯一地被通信两端的两个端点(即两个套接字) 所确定。即**TCP连接 ::= {socket1, socket2} = {(IP1: port1)，(IP2: port2)}**  

同一个 IP地址可以有多个不同的TCP连接。同一个端口号也可以出现在多个不同的TCP连接中。

### 4、可靠传输的工作原理

理想的传输条件有以下两个特点：

- 传输信道不产生差错
- 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据

在这样的理想传输条件下，不需要采取任何措施就能够实现可靠传输。然而实际的网络都不具备以上两个理想条件。必须使用一些可靠传输协议，在不可靠的传输信道实现可靠传输。

#### 4.1、停止等待协议

“停止等待”就是每发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组。全双工通信的双方既是发送方也是接收方。为了讨论问题的方便，我们仅考虑 A发送数据而 B接收数据并发送确认。因此 A叫做发送方，而 B叫做接收方。

##### 1）无差错情况

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226150909940.png" alt="image-20201226150909940" style="zoom:50%;" />

A发送分组M1，发完就暂停发送，等待B的确认(ACK)。B收到了 M1后向A发送ACK1。A在收到了对 M1的确认 ACK1后，就再发送下一个分组M2。

##### 2）出现差错

在接收方B会出现两种情况：

- B接收 M1时检测出了差错，就丢弃M1，其他什么也不做（不通知A 收到有差错的分组）
- M1在传输过程中丢失了，这时 B当然什么都不知道，也什么都不做。

在这两种情况下，B都不会发送任何信息。

如何保证 B正确收到了 M1呢？解决方法：超时重传

- A为每一个已发送的分组都设置了一个超时计时器

- A只要在超时计时器到期之前收到了相应的确认，就撤销该超时计时器，继续发送下一个分组M2

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226152330963.png" alt="image-20201226152330963" style="zoom:50%;" />

- 分组错误：A向 B发送数据M1，B没收到或者将其丢弃，B没有回复ACK，A等待 B回复的时间超时后，会重新重发M1，直到 A在超时时间内收到了 B回复的ACK
- 分组丢失同理

##### 3）确认丢失和确认迟到

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226153815543.png" alt="image-20201226153815543" style="zoom:50%;" />

- 确认丢失：若 B所发送的对 M1的确认丢失了，那么 A在设定的超时重传时间内不能收到确认，但 A并无法知道：是自己发送的分组出错、丢失了，或者是 B发送的确认丢失了。因此 A在超时计时器到期后就要重传M1。

  假定 B又收到了重传的分组M1。这时 B应采取两个行动：

  1. 丢弃这个重复的分组M1，不向上层交付
  2. 向 A发送确认。不能认为已经发送过确认就不再发送，因为 A之所以重传 M1就表示 A没有收到对 M1的确认

- 确认迟到：传输过程中没有出现差错，但 B对分组 M1的确认迟到了。

  A会收到重复的确认。对重复的确认的处理很简单：收下后就丢弃。B仍然会收到重复的M1，并且同样要丢弃重复的M1，并重传确认分组。

**请注意：**

- 在发送完一个分组后，必须暂时保留已发送的分组的副本，以备重发

- 分组和确认分组都必须进行编号

- 超时计时器的重传时间应当比数据在分组传输的平均往返时间更长一些

通常A最终总是可以收到对所有发出的分组的确认。如果 A不断重传分组但总是收不到确认，就说明通信线路太差，不能进行通信。使用上述的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。

**自动重传请求ARQ(Automatic Repeat reQuest)：**重传的请求是自动进行的，接收方不需要请求发送方重传某个出错的分组。

停止等待协议的优点是简单，缺点是信道利用率太低。

- 流水线传输：

  <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226155557211.png" alt="image-20201226155557211" style="zoom:50%;" />

  为了提高传输效率，发送方可以不使用低效率的停止等待协议，而是采用流水线传输。流水线传输就是发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认。这样可使信道上一直有数据不间断地传送。由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率。

#### 4.2、连续ARQ协议

滑动窗口协议比较复杂，是 TCP协议的精髓所在。发送方维持的发送窗口，它的意义是：位于发送窗口内的分组都可连续发送出去，而不需要等待对方的确认。这样，信道利用率就提高了。

连续ARQ协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226155755224.png" alt="image-20201226155755224" style="zoom:50%;" />

接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。

- 优点：容易实现，即使确认丢失也不必重传

- 缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息

如果发送方发送了前 5个分组，而中间的第 3个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。这就叫做Go-back-N (回退N)，表示需要再退回来重传已发送过的 N个分组。

可见当通信线路质量不好，经常丢弃数据时，连续ARQ协议会带来负面的影响。

TCP可靠通信的具体实现：

- TCP连接的每一端都必须设有两个窗口：一个发送窗口和一个接收窗口
- TCP的可靠传输机制用字节的序号进行控制。TCP所有的确认都是基于序号而不是基于报文段
- TCP两端的四个窗口经常处于动态变化之中
- TCP连接的往返时间RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间

### 5、TCP报文段的首部格式

TCP虽然是面向字节流的，但 TCP传送的数据单元却是报文段。一个 TCP报文段分为首部和数据两部分，而TCP的全部功能都体现在它首部中各字段的作用。

TCP报文段首部的前20个字节是固定的，后面有 4n字节是根据需要而增加的选项 (n是整数)。因此 TCP首部的最小长度是20字节。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226161841067.png" alt="image-20201226161841067" style="zoom:50%;" />

- 源端口和目的端口字段：各占 2字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现
- 序号字段：占4字节。TCP连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。如一个报文段的序号字段值是301，而携带的数据共有 100字节。这表明：本报文段的数据的第一个字节的序号是301，最后一个字节的序号是400。显然，下一个报文段(如果还有的话)的数据序号应当从 401开始，即下一个报文段的序号字段值应为401
- 确认号字段：占4字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。如 B正确收到了 A发送过来的一个报文段，其序号字段值是501，而数据长度是 200字节(序号501~700)， 这表明 B正确收到了 A发送的到序号 700为止的数据。因此，B期望收到 A的下一个数据序号是701，于是 B在发送给 A的确认报文段中把确认号置为701
- 数据偏移 (即首部长度)：占4位，它指出 TCP报文段的数据起始处距离 TCP报文段的起始处有多远，实际上是指出 TCP报文段的首部长度。“数据偏移”的单位是 32位字(以 4字节为计算单位)
- 保留字段：占6位，保留为今后使用，但目前应置为0
- 紧急URG ：当URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)
- 确认ACK：只有当ACK=1 时确认号字段才有效。当ACK=0 时，确认号无效
- 推送PSH(PuSH)：接收TCP收到PSH=1 的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付
- 复位RST(ReSeT)：当RST=1时，表明 TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接
- 同步SYN：同步SYN=1、ACK=0表示这是一个连接请求或连接接受报文
- 终止FIN(FINish)：用来释放一个连接。FIN=1表明此报文段的发送端的数据已发送完毕，并要求释放运输连接
- 窗口字段：占2字节，是发送本报文段的一方的接收窗口 (不是自己的发送窗口)。用来让对方设置发送窗口的依据，单位为字节
- 检验和：占2字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP报文段的前面加上12字节的伪首部
- 紧急指针字段：占16位，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）
- 选项字段：长度可变。TCP最初只规定了一种选项，即最大报文段长度MSS。MSS告诉对方 TCP：“我的缓存所能接收的报文段的数据字段的最大长度是 MSS个字节。”
- 填充字段：为了使整个首部长度是 4字节的整数倍

### 6、TCP可靠传输的实现

#### 6.1、以字节为单位的滑动窗口

TCP的滑动窗口是以字节为单位的。现假定 A收到了 B发来的确认报文段，其中窗口是 20字节，而确认号是31(这表明 B期望收到的下一个序号是31，而序号 30为止的数据已经收到了)。根据这两个数据，A就构造出自己的发送窗口

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226165426181.png" alt="image-20201226165426181" style="zoom:50%;" />

根据 B给出的窗口值，A构造出自己的发送窗口。发送窗口表示：在没有收到 B的确认的情况下，A可以连续把窗口内的数据都发送出去。 发送窗口里面的序号表示允许发送的序号。

显然，窗口越大，发送方就可以在收到对方确认之前连续发送更多的数据，因而可能获得更高的传输效率。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226174808294.png" alt="image-20201226174808294" style="zoom:50%;" />

只有当窗口内的数据按顺序被接收，滑动窗口才会向前推进，若接收窗口中从31~50序号的数据只有32、33没有接收到，那么滑动窗口会回退到序号32，重新将 32以及其后面的数据全部重新发送。

**发送缓存：发送方的应用进程把字节流写入 TCP的发送缓存接收缓存；接收方的应用进程从 TCP的接收缓存中读取字节流。**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226175812713.png" alt="image-20201226175812713" style="zoom:50%;" />

发送缓存与接收缓存的作用：

- 发送缓存用来暂时存放：
  - 发送应用程序传送给发送方 TCP准备发送的数据
  - TCP已发送出但尚未收到确认的数据
- 接收缓存用来暂时存放：
  - 按序到达的、但尚未被接收应用程序读取的数据
  - 不按序到达的数据

需要强调三点：

1. A的发送窗口并不总是和B的接收窗口一样大（因为有一定的时间滞后）
2. TCP标准没有规定对不按序到达的数据应如何处理。通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程
3. TCP要求接收方必须有累积确认的功能，这样可以减小传输开销

接收方发送确认：接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。

- 但请注意两点：
  1. 接收方不应过分推迟发送确认，否则会导致发送方不必要的重传，这反而浪费了网络的资源
  2. 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据

#### 6.2、超时重传时间的选择 

如果把超时重传时间设置得太短，就会引起很多报文段的不必要的重传，使网络负荷增大。但若把超时重传时间设置得过长，则又使网络的空闲时间增大，降低了传输效率。

TCP采用了一种自适应算法，它记录一个报文段发出的时间，以及收到相应的确认的时间。这两个时间之差就是报文段的往返时间RTT。

TCP保留了 RTT的一个加权平均往返时间RTT<sub>S</sub>（又称为平滑的往返时间）。第一次测量到RTT样本时，RTT<sub>S</sub> 值就取为所测量到的RTT样本值。以后每测量到一个新的RTT样本，就按下式重新计算一次RTT<sub>S</sub>：

新的RTT<sub>S</sub> =  (1 - a) × (旧的RTT<sub>S</sub>) + a × (新的RTT样本)（式中0≤a<1。若a很接近于零，表示 RTT值更新较慢。若选择 a接近于1，则表示RTT值更新较快）

#### 6.3、选择确认SACK

接收方收到了和前面的字节流不连续的两个字节块。如果这些字节的序号都在接收窗口之内，那么接收方就先收下这些数据，但要把这些信息准确地告诉发送方，使发送方不要再重复发送这些已收到的数据。在 TCP报文段的首部中都增加了 SACK选项，以便报告收到的不连续的字节块的边界。

### 7、TCP的流量控制

#### 7.1、利用滑动窗口实现流量控制

流量控制(flow control)就是让发送方的发送速率不要太快，要让接收方来得及接收。利用滑动窗口机制可以很方便地在 TCP连接上实现流量控制。

> 利用可变窗口进行流量控制举例
>
> A向B发送数据。在连接建立时，B告诉A：“我的接收窗口rwnd=400(字节)”（rwnd表示receiver window）。
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201226234322630.png" alt="image-20201226234322630" style="zoom: 67%;" />
>
> 由上图可知，接收方的主机B 进行了三次流量控制。第一次把窗口减小到rwnd=300，第二次又减到rwnd=100，最后减到rwnd=0，即不允许发送方再发送数据了。这种使发送方暂停发送的状态将持续到主机B 重新发出一个新的窗口值为止。每次流量控制，B向 A发送的报文段都设置了ACK=1，只有在ACK=1 时确认号字段才有意义。
>
> B向 A发送了零窗口的报文段后不久，B的接收缓存又有了一些存储空间。于是 B向 A发送了 rwnd=400的报文段。若这个报文段在传送过程中丢失了。A一直等待收到 B发送的非零窗口的通知，而 B也一直等待 A发送的数据。如果没有其他措施，这种互相等待的死锁局面将一直延续下去。
>
> 为了解决这个问题，TCP为每一个连接设有一个持续计时器 (persistence timer)

TCP为每一个连接设有一个持续计时器(persistence timer) 。只要 TCP连接的一方收到对方的零窗口通知，就启动该持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段 (仅携带1字节的数据)，而对方就在确认这个探测报文段时给出了现在的窗口值。

- 若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器

- 若窗口不是零，则死锁的僵局就可以打破了

#### 7.2、TCP 的传输效率

可以用不同的机制来控制 TCP报文段的发送时机：

- 第一种机制是 TCP维持一个变量，它等于最大报文段长度MSS。只要缓存中存放的数据达到 MSS字节时，就组装成一个 TCP报文段发送出去
- 第二种机制是由发送方的应用进程指明要求发送报文段，即 TCP支持的推送(push)操作
- 第三种机制是发送方的一个计时器期限到了，这时就把当前已有的缓存数据装入报文段（但长度不能超过MSS）发送出去。

如何控制 TCP发送报文段的时机仍然是一个较为复杂的问题。

- 发送方糊涂窗口综合症：发送方 TCP每次接收到 1字节的数据后就发送。这样，发送1个字节需要形成 41字节长的 IP数据报。若接收方确认，并回送这 1字节，就需传送总长度为 162字节共 4个报文段。效率很低。
  - 解决方法：使用Nagle算法。算法原理：若发送应用进程把要发送的数据逐个字节地送到 TCP的发送缓存，则发送方就把第一个数据字节先发送出去，把后面到达的数据字节都缓存起来。当发送方收到对第一个数据字符的确认后，再把发送缓存中的所有数据组装成一个报文段发送出去，同时继续对随后到达的数据进行缓存。只有在收到对前一个报文段的确认后才继续发送下一个报文段。当数据到达较快而网络速率较慢时，用这样的方法可明显地减少所用的网络带宽。Nagle算法还规定，当到达的数据已达到发送窗口大小的一半或已达到报文段的最大长度时，就立即发送一个报文段。这样做，就可以有效地提高网络的吞吐量。

- 接收方糊涂窗口综合症：当接收方的 TCP缓冲区已满，接收方会向发送方发送窗口大小为 0的报文。若此时接收方的应用进程以交互方式每次只读取一个字节，于是接收方又发送窗口大小为一个字节的更新报文，发送方应邀发送一个字节的数据 (发送的 IP数据报是41字节长)，于是接收窗口又满了，如此循环往复。
  - 解决方法：让接收方等待一段时间，使得或者接收缓存已有足够空间容纳一个最长的报文段，或者等到接收缓存已有一半空闲的空间。只要出现这两种情况之一，接收方就发出确认报文，并向发送方通知当前的窗口大小

### 8、TCP的拥塞控制

#### 8.1、拥塞控制的一般原理

拥塞(congestion)：在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。原因：**对资源需求的总和 > 当前网络的可用资源**。

- 增加资源能解决拥塞吗？不能。这是因为网络拥塞是一个非常复杂的问题。简单地采用上述做法，在许多情况下，不但不能解决拥塞问题，而且还可能使网络的性能更坏。
  - 网络拥塞往往是由许多因素引起的。例如：
    - 增大缓存，但未提高输出链路的容量和处理机的速度，排队等待时间将会大大增加，引起大量超时重传，解决不了网络拥塞
    - 提高处理机处理的速率会会将瓶颈转移到其他地方

如果一个路由器没有足够的缓存空间，它就会丢弃一些新到的分组。但当分组被丢弃时，发送这一分组的源点就会重传这一分组，甚至可能还要重传多次。这会引起更多的分组流入网络和被网络中的路由器丢弃。可见**拥塞引起的重传并不会缓解网络的拥塞，反而会加剧网络的拥塞。**

拥塞控制与流量控制的区别：

- > 拥塞控制就是防止过多的数据注入到网络中，使网络中的路由器或链路不致过载
  >
  > **拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷**
  >
  > **拥塞控制是一个全局性的过程**，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素

- > 流量控制往往指点对点通信量的控制，是个端到端的问题（接收端控制发送端）
  >
  > 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收（接收方告诉我接收窗口来调整我的发送窗口）

拥塞控制所起的作用：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201227003838292.png" alt="image-20201227003838292" style="zoom:50%;" />

开环控制方法就是在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。

闭环控制方法是基于反馈环路的概念。属于闭环控制的有以下几种措施：

1. 监测网络系统以便检测到拥塞在何时、何处发生
2. 将拥塞发生的信息传送到可采取行动的地方
3. 调整网络系统的运行以解决出现的问题

#### 8.2、TCP的拥塞控制方法

TCP采用基于窗口的方法进行拥塞控制。该方法属于闭环控制方法。

TCP发送方维持一个拥塞窗口cwnd (Congestion Window)，拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。

发送端利用拥塞窗口根据网络的拥塞情况调整发送的数据量。所以，发送窗口大小不仅取决于接收方窗口，还取决于网络的拥塞状况，所以真正的发送窗口值为：**真正的发送窗口值 = Min(接收方窗口值，拥塞窗口值)**

控制拥塞窗口的原则：只要网络没有出现拥塞，拥塞窗口就可以再增大一些，以便把更多的分组发送出去，这样就可以提高网络的利用率。但只要网络出现拥塞或有可能出现拥塞，就必须把拥塞窗口减小一些，以减少注入到网络中的分组数，以便缓解网络出现的拥塞。

##### 1）拥塞的判断

1. 重传定时器超时：现在通信线路的传输质量一般都很好，因传输出差错而丢弃分组的概率是很小的(远小于1%)。只要出现了超时，就可以猜想网络可能出现了拥塞。 

2. 收到三个相同 (重复) 的ACK：在传输中个别报文段会在网络中丢失，预示可能会出现拥塞(实际未发生拥塞)，因此可以尽快采取控制措施，避免拥塞。

##### 2）TCP拥塞控制算法

四种拥塞控制算法(RFC5681)：慢开始(slow-start)、拥塞避免(congestion avoidance)、快重传(fast retransmit)、快恢复(fast recovery)

- 慢开始 (Slow start)：用来确定网络的负载能力
  - 算法的思路：由小到大逐渐增大拥塞窗口数值

  - 初始拥塞窗口 cwnd设置：

    - 旧的规定：在刚刚开始发送报文段时，先把初始拥塞窗口 cwnd设置为1至2个发送方的最大报文段 SMSS(Sender Maximum Segment Size)的数值
    - 新的RFC5681把初始拥塞窗口 cwnd设置为不超过 2至 4个 SMSS的数值

  - 慢开始门限ssthresh(状态变量)：防止拥塞窗口cwnd增长过大引起网络拥塞

  - 拥塞窗口cwnd 控制方法：在每收到一个对新的报文段的确认后，可以把拥塞窗口增加最多一个 SMSS的数值

    - 拥塞窗口cwnd每次的增加量 = min(N, SMSS)（N是原先未被确认的、但现在被刚收到的确认报文段所确认的字节数）不难看出，当 N<SMSS 时，拥塞窗口每次的增加量要小于SMSS。

    <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228134347236.png" alt="image-20201228134347236" style="zoom: 60%;" />

    发送方先设置cwnd=1。如果发送方发送一个数据没丢失，就使 cwnd加1，此时cwnd=2；下一次发送 2个数据，若发送的数据都没丢失，cwnd加2，此时cwnd=4；下次再发送的4个数据。以此类推。

为了防止拥塞窗口 cwnd增长过大引起网络拥塞，还需要设置慢开始门限状态变量ssthresh，慢开始门限状态变量 ssthresh的用法如下：

- 当 cwnd<ssthresh 时，使用慢开始算法
- 当 cwnd>ssthresh 时，停止使用慢开始算法而改用拥塞避免算法
- 当 cwnd=ssthresh 时，既可使用慢开始算法，也可使用拥塞避免算法

**拥塞避免算法：每经过一个往返时间 RTT就把发送方的拥塞窗口 cwnd加1，而不是加倍**，使拥塞窗口 cwnd按线性规律缓慢增长。

- 一个传输轮次所经历的时间其实就是往返时间RTT。如拥塞窗口cwnd=4，这时的往返时间RTT 就是发送方连续发送 4个报文段，并收到这 4个报文段的确认，总共经历的时间。

因此在拥塞避免阶段就有“加法增大”(Additive Increase)的特点。这表明在拥塞避免阶段，拥塞窗口cwnd 按线性规律缓慢增长，比慢开始算法的拥塞窗口增长速率缓慢得多。

“拥塞避免”并非指完全能够避免了拥塞。利用以上的措施要完全避免网络拥塞还是不可能的。“拥塞避免”是说在拥塞避免阶段把拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。

> **慢开始和拥塞避免算法的实现举例**
>
> 当TCP连接进行初始化时，将拥塞窗口置为1。图中的窗口单位不使用字节而使用报文段。慢开始门限的初始值设置为 16个报文段，即ssthresh=16。窗口值cwnd=ssthresh+ssthresh/2
>
> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228141422453.png" alt="image-20201228141422453" style="zoom:50%;" />
>
> 在执行慢开始算法时，拥塞窗口cwnd=1，发送第一个报文段。发送方每收到一个对新报文段的确认ACK，就把拥塞窗口值加1，然后开始下一轮的传输（请注意，横坐标是传输轮次，不是时间）。因此拥塞窗口 cwnd随着传输轮次按指数规律增长。
>
> 当拥塞窗口cwnd 增长到慢开始门限值ssthresh 时(图①，此时拥塞窗口cwnd=16)，就改为执行拥塞避免算法，拥塞窗口按线性规律增长。当拥塞窗口cwnd=ssthresh=24时，网络出现了超时(图②)，发送方判断为网络拥塞。于是调整门限值ssthresh=cwnd/2=12，同时设置拥塞窗口cwnd=1，进入慢开始阶段。按照慢开始算法，发送方每收到一个对新报文段的确认ACK，就把拥塞窗口值加1。当拥塞窗口cwnd=ssthresh=12时（图③，这是新的ssthresh值），改为执行拥塞避免算法，拥塞窗口按线性规律增大。
>
> 当拥塞窗口cwnd=16时(图④)，出现了一个新的情况，就是发送方一连收到 3个对同一个报文段的重复确认(图中记为3-ACK)。发送方改为执行快恢复算法。

快重传算法：采用快重传FR(Fast Retransmission)算法可以让发送方尽早知道发生了个别报文段的丢失

- 快重传算法首先要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认，即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认。

快恢复算法：发送方只要一连收到三个重复确认，就知道接收方确实没有收到报文段，因而应当立即进行重传(即“快重传”)，这样就不会出现超时，发送方也不就会误认为出现了网络拥塞。

- 当发送端收到连续三个重复的确认时，由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，而是执行快恢复算法FR(Fast Recovery) 算法：
  1. 慢开始门限ssthresh=当前拥塞窗口cwnd/2 
  2. 新拥塞窗口 cwnd = 慢开始门限ssthresh
  3. 开始执行拥塞避免算法，使拥塞窗口缓慢地线性增大

> <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228161254358.png" alt="image-20201228161254358" style="zoom:50%;" />
>
> 在图④，发送方知道现在只是丢失了个别的报文段。于是不启动慢开始，而是执行快恢复算法。这时，发送方调整门限值ssthresh= cwnd/2=8，同时设置拥塞窗口 cwnd=ssthresh=8（见图⑤），并开始执行拥塞避免算法。

发送窗口的上限值：应当取为接收方窗口rwnd 和拥塞窗口cwnd 这两个变量中较小的一个。即应按此公式确定：`发送窗口的上限值 = Min[rwnd, cwnd]`

- 当 rwnd<cwnd 时，是接收方的接收能力限制发送窗口的最大值
- 当 cwnd<rwnd 时，则是网络的拥塞限制发送窗口的最大值

也就是说，rwnd和 cwnd中数值较小的一个，控制了发送方发送数据的速率。

#### 8.3、主动队列管理AQM

TCP拥塞控制和网络层采取的策略有密切联系。重传会使 TCP连接的发送端认为在网络中发生了拥塞。于是在 TCP的发送端就采取了拥塞控制措施，但实际上网络并没有发生拥塞。

网络层的策略对 TCP拥塞控制影响最大的就是路由器的分组丢弃策略。一般情况下，路由器的队列通常都是按照“先进先出”FIFO (First In First Out)的规则处理到来的分组。由于队列长度总是有限的，因此当队列已满时，以后再到达的所有分组(如果能够继续排队，这些分组都将排在队列的尾部)将都被丢弃。这就叫做尾部丢弃策略(tail-drop policy)。路由器的尾部丢弃往往会导致一连串分组的丢失，这就使发送方出现超时重传，使 TCP进入拥塞控制的慢开始状态，结果使 TCP连接的发送方突然把数据的发送速率降低到很小的数值。

更为严重的是，在网络中通常有很多的 TCP连接，这些连接中的报文段通常是复用在网络层的IP数据报中传送的。在这种情况下，若发生了路由器中的尾部丢弃，就可能会同时影响到很多条 TCP连接，结果使这许多 TCP连接在同一时间突然都进入到慢开始状态。这在 TCP 的术语中称为全局同步 (global syncronization)。全局同步使得全网的通信量突然下降了很多，而在网络恢复正常后，其通信量又突然增大很多。

**主动队列管理AQM：AQM实际上就是对路由器中的分组排队进行智能管理，而不是简单地把队列的尾部丢弃。**

- “主动”就是不要等到路由器的队列长度已经达到最大值时才不得不丢弃后面到达的分组。这样就太被动了。应当在队列长度达到某个值得警惕的数值时（即当网络拥塞有了某些拥塞征兆时），就主动丢弃到达的分组。

### 9、TCP的运输连接管理

TCP是面向连接的协议。运输连接是用来传送 TCP报文的。运输连接有三个阶段：连接建立、数据传送（前面讲的是这一部分）、连接释放。运输连接的管理就是使运输连接的建立和释放都能正常地进行。

TCP连接建立过程中要解决的三个问题：

1. 要使每一方能够确知对方的存在
2. 要允许双方协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）
3. 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配

TCP连接的建立采用**客户服务器方式**。主动发起连接建立的应用进程叫做客户(client)，被动等待连接建立的应用进程叫做服务器(server)

#### 9.1、TCP的连接建立

**TCP建立连接的过程叫做握手。握手需要在客户和服务器之间交换三个TCP报文段。**称之为三报文握手。采用三报文握手主要是为了防止已失效的连接请求报文段突然又传送到了，因而产生错误。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228165111901.png" alt="image-20201228165111901" style="zoom:50%;" />

1. A的TCP向B发出连接请求报文段，其首部中的同步位SYN=1，并随机选择序号seq=x，表明 A传送数据时的首个数据字节的序号是x，此时TCP客户进程进入 SYN-SENT(同步已发送)状态。
2. B的 TCP收到连接请求报文段后，如同意建立连接，则向 A发回确认。B在确认报文段中应使SYN=1、ACK=1，因为已经收到了序列号为x的数据包，准备接收序列号为x+1的包，所以ack=x+1，同时告诉A自己发送数据的初始序列号seq=y，这时 TCP服务器进程进 SYN-RCVD(同步收到)状态。
3. A收到此报文段后向 B给出确认报文段，其ACK=1，自己的序号seq=x+1，SYN=0，而ack=y+1是表示 A正准备接收 B序列号为 y+1的数据包。A的 TCP通知上层应用进程，TCP连接已经建立；B的 TCP收到主机 A 的确认后，也通知其上层应用进程，TCP连接已经建立。此时TCP连接已经建立，A进入ESTABLISHED(已建立连接)状态。当 B收到 A的确认后，也进入ESTABLISHED状态。

#### 9.2、TCP的连接释放

TCP连接释放过程是四报文挥手。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228171241566.png" alt="image-20201228171241566" style="zoom:50%;" />

1. 数据传输结束后，通信的双方都可释放连接。若A的应用进程先向其 TCP发出连接释放报文段，并停止发送数据，主动关闭 TCP连接。A把连接释放报文段首部的FIN=1，其序号seq=u，A进入 FIN-WAIT-1 (终止等待1)状态，等待B的确认。
2. B发出确认，确认号ack=u+1，自己的序号seq=v，ACK=1。TCP服务器进程通知高层应用进程。从 A到 B这个方向的连接就释放了，TCP连接处于半关闭状态。B若发送数据，A仍要接收。就进入CLOSE-WAIT（关闭等待）状态。A收到来自B的确认后，就进入FIN-WAIT-2 (终止等待2)状态，等待B发出的连接释放报文段。==（若 B已经没有要向 A发送的数据，其应用进程就通知 TCP释放连接。这时 B发出的连接释放报文段必须使 FIN=1。现假定B的序号为w (在半关闭状态B可能又发送了一些数据)。B还必须重复上次已发送过的确认号ack=u+1。这时B就进入LAST-ACK (最后确认)状态，等待A的确认。）==
3.  A收到连接释放报文段后，必须发出确认。在确认报文段中ACK=1，确认号ack=w+1，自己的序号seq=u+1。然后进入到TIME-WAIT (时间等待)状态。请注意，现在 TCP连接还没有释放掉。必须经过时间等待计时器(TIME-WAIT timer)设置的时间2MSL后，A才进入到CLOSED状态。时间 MSL叫做最长报文段寿命(Maximum Segment Lifetime)，设置为2min。

## 第六章 应用层

应用层协议的特点：

- 每个应用层协议都是为了解决某一类应用问题，而问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的。应用层的具体内容就是规定应用进程在通信时所遵循的协议。

- 应用层的许多协议都是基于客户服务器方式。客户(client)和服务器(server)都是指通信中所涉及的两个应用进程。客户服务器方式所描述的是进程之间服务和被服务的关系。客户是服务请求方，服务器是服务提供方。 

### 1、域名系统DNS

#### 1.1、域名系统概述

域名系统DNS(Domain Name System)——从域名解析出IP地址。

许多应用层软件经常直接使用域名系统DNS，但计算机的用户只是间接而不是直接使用域名系统。 互联网采用层次结构的命名树作为主机的名字，并使用分布式的域名系统DNS。名字到IP地址的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，运行该程序的机器称为域名服务器。

#### 1.2、互联网的域名结构

互联网采用了层次树状结构的命名方法。任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构的名字，即域名。

域名的结构由标号序列组成，各标号之间用点隔开：**… .三级域名 .二级域名 .顶级域名**（各标号分别代表不同级别的域名）。

域名只是个逻辑概念，并不代表计算机所在的物理地点。变长的域名和使用有助记忆的字符串，是为了便于人来使用。而IP地址是定长的 32位二进制数字则非常便于机器进行处理。

域名中的“点”和点分十进制 IP 地址中的“点”并无一一对应的关系。点分十进制 IP 地址中一定是包含三个“点”，但每一个域名中“点”的数目则不一定正好是三个。

互联网的域名空间：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228225600547.png" alt="image-20201228225600547" style="zoom:50%;" />

#### 1.3、域名服务器

一个服务器所负责管辖的(或有权限的)范围叫做区(zone)。各单位根据具体情况来划分自己管辖范围的区。但在一个区中的所有节点必须是能够连通的。每一个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到 IP 地址的映射。

DNS服务器的管辖范围不是以“域”为单位，而是以“区”为单位。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201228225932902.png" alt="image-20201228225932902" style="zoom:50%;" />

- 根域名服务器：
  - 是最高层次的域名服务器，也是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址
  - 不管是哪一个本地域名服务器，若要对互联网上任何一个域名进行解析，只要自己无法解析，就首先求助于根域名服务器
  - 在互联网上共有13个不同IP地址的根域名服务器，它们的名字是用一个英文字母命名，从a一直到m(前13个字母)
    - 根域名服务器并不直接把域名直接转换成IP地址
    - 在使用迭代查询时，根域名服务器把下一步应当找的顶级域名服务器的IP地址告诉本地域名服务器
- 顶级域名服务器：负责管理在该顶级域名服务器注册的所有二级域名
  - 当收到 DNS 查询请求时，就给出相应的回答(可能是最后的结果，也可能是下一步应当找的域名服务器的IP地址)
- 权限域名服务器：负责一个区的域名服务器
  - 当一个权限域名服务器还不能给出最后的查询回答时，就会告诉发出查询请求的DNS客户，下一步应当找哪一个权限域名服务器
- 本地域名服务器：本地域名服务器对域名系统非常重要，当一个主机发出DNS查询请求时，这个查询请求报文就发送给本地域名服务器。每一个互联网服务提供者ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本地域名服务器，这种域名服务器有时也称为默认域名服务器

每个域名服务器都维护一个高速缓存，存放最近用过的名字以及从何处获得名字映射信息的记录。可大大减轻根域名服务器的负荷，使互联网上的 DNS 查询请求和回答报文的数量大为减少。

为保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器，并处理超过合理时间的项（如每个项目只存放两天）。

当权限域名服务器回答一个查询请求时，在响应中都指明绑定有效存在的时间值。增加此时间值可减少网络开销，而减少此时间值可提高域名转换的准确性。

### 2、文件传送协议

#### 2.1、FTP概述

文件传送协议FTP(File Transfer Protocol)是互联网上使用得最广泛的文件传送协议。FTP提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。

#### 2.2、FTP的基本工作原理

网络环境下复制文件的复杂性：

1. 计算机存储数据的格式不同
2. 文件的目录结构和文件命名的规定不同
3. 对于相同的文件存取功能，操作系统使用的命令不同
4. 访问控制方法不同

文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 TCP 可靠的运输服务。FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。

FTP使用客户服务器方式。一个FTP服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求。

FTP特点：

1. 只提供文件传送的一些基本的服务，它使用 TCP 可靠的运输服务
2. 主要功能是减少或消除在不同操作系统下处理文件的不兼容性
3. 使用客户服务器方式。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求

主进程的工作步骤：

1. 打开熟知端口（端口号为 21），使客户进程能够连接上
2. 等待客户进程发出连接请求
3. 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
4. 回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行

#### 2.3、简单文件传送协议TFTP

TFTP(Trivial File Transfer Protocol)是一个很小且易于实现的文件传送协议。TFTP使用客户服务器方式和UDP数据报，因此TFTP需要有自己的差错改正措施。

TFTP只支持文件传输而不支持交互。TFTP没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别。

**TFTP** **的主要特点**：

- 每次传送的数据PDU中有512字节的数据，但最后一次可不足512字节
- 数据PDU也称为文件块(block)，每个块按序编号，从1开始
- 支持ASCII码或二进制传送
- 可对文件进行读或写
- 使用很简单的首部

### 3、远程终端协议TELNET

TELNET是一个简单的远程终端协议，也是互联网的正式标准。

用户用TELNET就可在其所在地通过TCP连接注册（即登录）到远地的另一个主机上(使用主机名或IP地址)。TELNET能将用户的击键传到远地主机，同时也能将远地主机的输出通过TCP连接返回到用户屏幕。这种服务是透明的，因为用户感觉到好像键盘和显示器是直接连在远地主机上。

TELNET也使用客户-服务器方式。在本地系统运行TELNET客户进程，而在远地主机则运行TELNET服务器进程。和FTP的情况相似，服务器中的主进程等待新的请求，并产生从属进程来处理每一个连接。

### 4、万维网WWW

#### 4.1、万维网概述

万维网www(World Wide Web)是一个大规模的、联机式的信息储藏所，英文简称为Web。万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点（也就是所谓的“链接到另一个站点”)，从而主动地按需获取丰富的信息。这种访问方式称为“链接”。

万维网是分布式超媒体 (hypermedia) 系统，它是超文本 (hypertext) 系统的扩充。一个超文本由多个信息源链接成。利用一个链接可使用户找到另一个文档。这些文档可以位于世界上任何一个接在互联网上的超文本系统中。超文本是万维网的基础。

超媒体与超文本的区别是文档内容不同。超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图形、图像、声音、动画，甚至活动视频图像。

**万维网以客户——服务器方式工作。**浏览器就是在用户计算机上的万维网客户程序。万维网文档所驻留的计算机则运行服务器程序，因此这个计算机也称为万维网服务器。客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档。在一个客户程序主窗口上显示出的万维网文档称为页面(page)。

**万维网必须解决的问题**：

1. 怎样标志分布在整个互联网上的万维网文档？ 

   使用统一资源定位符 URL (Uniform Resource Locator) 来标志万维网上的各种文档。使每一个文档在整个互联网的范围内具有唯一的标识符URL。 

2. 用何协议实现万维网上各种超链的链接？ 

   在万维网客户程序与万维网服务器程序之间进行交互所使用的协议，是超文本传送协议HTTP(HyperText Transfer Protocol)。HTTP是一个应用层协议，它使用TCP连接进行可靠的传送。 

3. 怎样使各种万维网文档都能在互联网上的各种计算机上显示出来，同时使用户清楚地知道在什么地方存在着超链？ 

   超文本标记语言HTML(HyperText Markup Language)使得万维网页面的设计者可以很方便地用一个超链从本页面的某处链接到互联网上的任何一个万维网页面，并且能够在自己的计算机屏幕上将这些页面显示出来。

4. 怎样使用户能够很方便地找到所需的信息？ 

   为了在万维网上方便地查找信息，用户可使用各种的搜索工具（即搜索引擎）。 

#### 4.2、统一资源定位符URL

资源定位符URL 是对可以从互联网上得到的资源的位置和访问方法的一种简洁表示。URL给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位。

URL相当于一个文件名在网络范围的扩展。因此**URL是与互联网相连的机器上的任何可访问对象的一个指针。**

URL的一般形式：由以冒号隔开的两大部分组成，并且在 URL 中的字符对大写或小写没有要求。<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201229105728782.png" alt="image-20201229105728782" style="zoom:67%;" />

#### 4.3、超文本传送协议HTTP

##### 4.3.1、HTTP的操作过程

为了使超文本的链接能够高效率地完成，需要用 HTTP协议来传送一切必须的信息。从层次的角度看，**HTTP是面向事务的 (transaction-oriented)应用层协议**，它是万维网上能够可靠地交换文件(包括文本、声音、图像等各种多媒体文件)的重要基础。

每个万维网网点都有一个服务器进程，它不断地监听TCP的端口 80，以便发现是否有浏览器向它发出连接建立请求。

一旦监听到连接建立请求并建立了TCP连接之后，浏览器就向万维网服务器发出浏览某个页面的请求，服务器接着就返回所请求的页面作为响应。最后，TCP连接就被释放了。

在浏览器和服务器之间的请求和响应的交互，必须按照规定的格式和遵循一定的规则。这些格式和规则就是超文本传送协议HTTP。

HTTP规定在 HTTP 客户与 HTTP 服务器之间的每次交互，都由一个ASCII码串构成的请求和一个类似的通用互联网扩充，即“类MIME (MIME-like)”的响应组成。

**HTTP报文通常都使用TCP连接传送。**

- 用户点击URL后所发生的事件：
  1. 浏览器分析超链指向页面的URL
  2. 浏览器向DNS请求解析网站的IP地址
  3. 域名系统DNS解析出清华大学服务器的IP地址
  4. 浏览器与服务器建立TCP连接
  5. 浏览器发出取文件命令:GET /chnlyxsz/index.htm
  6. 服务器给出响应，把文件index.htm发给浏览器
  7. TCP连接释放
  8. 浏览器显示页面内容

##### 4.3.2、代理服务器

代理服务器(proxy server)又称为万维网高速缓存(Web cache)，它代表浏览器发出HTTP请求。万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中。当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按URL的地址再去互联网访问该资源。

##### 4.3.3、HTTP的报文结构

HTTP有两类报文：

- 请求报文：从客户向服务器发送请求报文

- 响应报文：从服务器到客户的回答

由于HTTP是面向正文的(text-oriented)，因此在报文中的每一个字段都是一些 ASCII 码串，因而每个字段的长度都是不确定的。

请求报文由三个部分组成，即开始行、首部行和实体主体。在请求报文中，开始行就是请求行。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201229112601677.png" alt="响应报文" style="zoom:50%;" />



- “方法”是面向对象技术中使用的专门名词。是对所请求的对象进行的操作，因此这些方法实际上也就是一些命令。因此，请求报文的类型是由它所采用的方法决定的。

  - HTTP请求报文的一些方法： 

    | 方法 (操作) |              意义               |
    | :---------: | :-----------------------------: |
    |   OPTION    |       请求一些选项的信息        |
    |     GET     |    请求读取由URL所标志的信息    |
    |    HEAD     | 请求读取由URL所标志的信息的首部 |
    |    POST     | 给服务器添加信息（例如，注释）  |
    |     PUT     |    在指明的URL下存储一个文档    |
    |   DELETE    |    删除指明的URL所标志的资源    |
    |    TRACE    |   用来进行环回测试的请求报文    |
    |   CONNECT   |         用于代理服务器          |

- URL：所请求的资源的 URL
- 版本：HTTP的版本

响应报文的开始行是状态行。状态行包括三项内容：HTTP的版本，状态码，以及解释状态码的简单短语。 

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201229113918905.png" alt="image-20201229113918905" style="zoom:50%;" />

- 状态码：都是三位数字
  - 1xx表示通知信息的，如请求收到了或正在进行处理
  - 2xx表示成功，如接受或知道了
  - 3xx表示重定向，表示要完成请求还必须采取进一步的行动
  - 4xx表示客户的差错，如请求中有错误的语法或不能完成
  - 5xx表示服务器的差错，如服务器失效无法完成请求

##### 4.3.4、在服务器上存放用户的信息

万维网站点使用 Cookie来跟踪用户。Cookie表示在 HTTP服务器和客户之间传递的状态信息。使用 Cookie的网站服务器为用户产生一个唯一的识别码。利用此识别码，网站就能够跟踪该用户在该网站的活动。 

#### 4.4、万维网的文档

##### 4.4.1、超文本标记语言HTML

超文本标记语言HTML(HyperText Markup Language)中的 Markup的意思就是“设置标记”。HTML定义了许多用于排版的命令(即标签)。HTML把各种标签嵌入到万维网的页面中。这样就构成了所谓的HTML文档。HTML文档是一种可以用任何文本编辑器创建的ASCII 码文件。  

HTML还规定了链接的设置方法。每个链接都有一个起点和终点。

- 远程链接：超链的终点是其他网点上的页面
- 本地链接：超链指向本计算机中的某个文件

#### 4.5、万维网的信息检索系统

在万维网中用来进行搜索的程序叫做搜索引擎。

- 全文检索搜索引擎：是一种纯技术型的检索工具。其工作原理是通过搜索软件到互联网上的各网站收集信息，找到一个网站后可以从这个网站再链接到另一个网站。然后按照一定的规则建立一个很大的在线数据库供用户查询。用户在查询时只要输入关键词，就从已经建立的索引数据库上进行查询（并不是实时地在互联网上检索到的信息）。

- 分类目录搜索引擎：不采集网站的任何信息，而是利用各网站向搜索引擎提交的网站信息时填写的关键词和网站描述等信息，经过人工审核编辑后，如果符合网站登录的条件，则输入到分类目录的数据库中，供网上用户查询。分类目录搜索也叫做分类网站搜索。
- 垂直搜索引擎(Vertical Search Engine)：针对某一特定领域、特定人群或某一特定需求提供搜索服务。垂直搜索也是提供关键字来进行搜索的，但被放到了一个行业知识的上下文中，返回的结果更倾向于信息、消息、条目等。 

### 5、电子邮件

#### 5.1、电子邮件概述

电子邮件 (e-mail) 是互联网上使用得最多的和最受用户欢迎的一种应用。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器进行读取。它不仅使用方便，而且还具有传递迅速和费用低廉的优点。

电子邮件的一些标准：

- 发送邮件的协议：简单邮件传送协议SMTP(Simple Mail Transfer Protocol)

- 读取邮件的协议：邮局协议POP3(Post Office Protocol-3)和网际报文存取协议IMAP(Internet Message Aeeess Protoeol)

- 通用互联网邮件扩充MIME(Multipurpose Internet Mail Extensions)：在其邮件首部中说明了邮件的数据类型(如文本、声音、图像、视像等)，使用 MIME可在邮件中同时传送多种类型的数据。 

**电子邮件的最主要的组成构件**：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201229231651206.png" alt="image-20201229231651206" style="zoom: 50%;" />

- 用户代理UA(User Agent)：用户与电子邮件系统的接口，是电子邮件客户端软件。功能：撰写、显示、处理和通信
- 邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。邮件服务器按照客户-服务器方式工作。邮件服务器需要使用发送和读取两个不同的协议。一个邮件服务器既可以作为客户，也可以作为服务器。

发送和接收电子邮件的几个重要步骤：

1. 发件人调用 PC中的用户代理撰写和编辑要发送的邮件
2. 发件人的用户代理把邮件用 SMTP协议发给发送方邮件服务器
3. SMTP 服务器把邮件临时存放在邮件缓存队列中，等待发送
4. 发送方邮件服务器的 SMTP客户与接收方邮件服务器的 SMTP服务器建立 TCP连接，然后就把邮件缓存队列中的邮件依次发送出去
5. 运行在接收方邮件服务器中的 SMTP服务器进 程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取
6. 收件人在打算收信时，就运行 PC机中的用户代理，使用POP3（或IMAP）协议读取发送给自己的邮件

电子邮件的组成：由信封(envelope) 和内容(content) 两部分组成。电子邮件的传输程序根据邮件信封上的信息来传送邮件。用户在从自己的邮箱中读取邮件时才能见到邮件的内容。在邮件的信封上，最重要的就是收件人的地址。 

- 电子邮件地址的格式：收件人邮箱名@邮箱所在主机的域名，如`xiexiren@tsinghua.org.cn`

#### 5.2、简单邮件传送协议SMTP

SMTP所规定的就是在两个相互通信的 SMTP进程之间应如何交换信息。由于 SMTP使用客户–服务器方式，因此负责发送邮件的 SMTP进程就是 SMTP客户，而负责接收邮件的 SMTP进程就是 SMTP服务器。

SMTP规定了 14条命令和 21种应答信息。每条命令用 4个字母组成，而每一种应答信息一般只有一行信息，由一个 3位数字的代码开始，后面附上（也可不附上）很简单的文字说明。 

SMTP通信的三个阶段：

1. 连接建立：连接是在发送主机的 SMTP客户和接收主机的 SMTP服务器之间建立的，SMTP不使用中间的邮件服务器  

2. 邮件传送

3. 连接释放：邮件发送完毕后，SMTP应释放 TCP连接

#### 5.3、电子邮件的信息格式

一个电子邮件分为信封和内容两大部分。RFC 822只规定了邮件内容中的首部(header) 格式，而对邮件的主体(body )部分则让用户自由撰写。用户写好首部后，邮件系统将自动地将信封所需的信息提取出来并写在信封上。所以用户不需要填写电子邮件信封上的信息。

邮件内容首部包括一些关键字，后面加上冒号。最重要的关键字是：To 和 Subject。  

- 邮件内容的首部：
  - To：后面填入一个或多个收件人的电子邮件地址。用户只需打开地址簿，点击收件人名字，收件人的电子邮件地址就会自动地填入到合适的位置上
  - Subject： 是邮件的主题。它反映了邮件的主要内容，便于用户查找邮件
  - Cc 表示应给某某人发送一个邮件副本
  - From和 Date：表示发信人的电子邮件地址和发信日期
  - Reply-To：是对方回信所用的地址

#### 5.4、邮件读取协议POP3和IMAP

邮局协议POP ：一个非常简单、但功能有限的邮件读取协议，现在使用的是它的第三个版本POP3。它也使用客户–服务器的工作方式。在接收邮件的用户 PC机中必须运行 POP客户程序，而在用户所连接的 ISP的邮件服务器中则运行 POP服务器程序。

IMAP(Internet Message Access Protocol)：一个联机协议。当用户 PC机上的 IMAP客户程序打开 IMAP服务器的邮箱时，用户就可看到邮件的首部。若用户需要打开某个邮件，则该邮件才传到用户的计算机上。也是按客户服务器方式工作。

用户在自己的 PC机上就可以操纵 ISP的邮件服务器的邮箱，就像在本地操纵一样。

- 特点：
  - IMAP最大的好处就是用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件
  - IMAP允许收件人只读取邮件中的某一个部分。如收到了一个带有视像附件（此文件可能很大）的邮件。为了节省时间，可以先下载邮件的正文部分，待以后有时间再读取或下载这个很长的附件
  - 缺点：如果用户没有将邮件复制到自己的 PC上，邮件则是存放在 IMAP服务器上。因此用户需要经常与 IMAP服务器建立连接

**注意：不要将邮件读取协议 POP或 IMAP与邮件传送协议 SMTP弄混**

- **发信人的用户代理向源邮件服务器发送邮件，以及源邮件服务器向目的邮件服务器发送邮件，都是使用 SMTP 协议**
- **POP协议或 IMAP协议则是用户从目的邮件服务器上读取邮件所使用的协议**

#### 5.5、基于万维网的电子邮件

电子邮件从 A发送到网易邮件服务器使用 HTTP协议。两个邮件服务器之间的传送使用SMTP。邮件从新浪邮件服务器传送到 B是使用 HTTP协议。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201230153153891.png" alt="image-20201230153153891" style="zoom:50%;" />

万维网电子邮件的好处：只要能够找到上网的计算机，打开任何一种浏览器就可以非常方便地收发电子邮件。

#### 5.6、通用互联网邮件扩充MIME

通用互联网邮件扩充MIME 并没有改动SMTP 或取代它。MIME的意图是继续使用目前的 [RFC 822] 格式，但增加了邮件主体的结构，并定义了传送非 ASCII码的编码规则。

### 6、动态主机配置协议DHCP

一个IP地址指出了一台计算机连接在哪一个网络上。当计算机还在生产时，无法知道它在出厂后将被连接到哪一个网络上。因此，需要连接到互联网的计算机，必须对IP地址等项目进行协议配置。
用人工进行协议配置很不方便，而且容易出错。因此，应当采用自动协议配置的方法。互联网现在广泛使用的是动态主机配置协议DHCP (Dynamic Host ConfigurationProtocol)，它提供了插即用连网(plug-and-play networking)机制。这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与。

需要 IP地址的主机在启动时就向 DHCP服务器广播发送发现报文(DHCPDISCOVER)，这时该主机就成为 DHCP客户。本地网络上所有主机都能收到此广播报文，但只有 DHCP服务器才回答此广播报文。

DHCP服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的 IP地址池 (address pool) 中取一个地址分配给该计算机。DHCP服务器的回答报文叫做提供报文(DHCPOFFER)。

**DHCP中继代理(relay agent)**：并不是每个网络上都有 DHCP服务器，这样会使 DHCP服务器的数量太多。现在是每一个网络至少有一个 DHCP中继代理，它配置了 DHCP服务器的 IP地址信息。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201230162939203.png" alt="image-20201230162939203" style="zoom:50%;" />

当 DHCP中继代理收到主机发送的发现报文后，就以单播方式向 DHCP服务器转发此报文，并等待其回答。收到 DHCP服务器回答的提供报文后，DHCP中继代理再将此提供报文发回给主机。

### 7、简单网络管理协议SNMP

#### 7.1、网络管理的基本概念

网络管理还没有精确定义，它的内容可归纳为：网络管理包括对硬件、软件和人力的使用、综合与协调，以便对网络资源进行监视、测试、配置、分析、评价和控制，这样就能以合理的价格满足网络的一些需求，如实时运行性能、服务质量等。网络管理常简称为网管。

网络管理的一般模型：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201230170126633.png" alt="image-20201230170126633" style="zoom:50%;" />

- 管理站：也常称为网络运行中心NOC(Network Operations Center)，是网络管理系统的核心

- 管理程序在运行时就成为管理进程。

管理站(硬件)或管理程序(软件)都可称为管理者(manager)

- Manager不是指人而是指机器或软件
- 网络管理员(administrator)：指人，大型网络往往实行多级管理，因而有多个管理者，而一个管理者一般只管理本地网络的设备
- 被管对象：网络中的每一个被管设备中可能有多个被管对象，被管设备有时可称为网络元素或网元。在被管设备中也会有一些不能被管的对象

在每一个被管设备中都要运行一个程序以便和管理站中的管理程序进行通信。这些运行着的程序叫做网络管理代理程序，或简称为代理。代理程序在管理程序的命令和控制下在被管设备上采取本地的行动。

简单网络管理协议SNMP(Simple Network Management Protocol)以管理程序和代理程序按客户服务器方式工作。管理程序运行SNMP客户程序，而代理程序运行 SNMP服务器程序。在被管对象上运行的 SNMP服务器程序不停地监听来自管理站的 SNMP客户程序的请求(或命令)。一旦发现了，就立即返回管理站所需的信息，或执行某个动作(如把某个参数的设置进行更新)。在网管系统中往往是一个(或少数几个)客户程序与很多的服务器程序进行交互。

设计理念：若要管理某个对象，就必然会给该对象添加一些软件或硬件,但这种“添加”对原有对象的影响必须尽量小些。

SNMP的网络管理的组成：SNMP本身、管理信息结构SMI (Structure ofManagement Information)和管理信息库MIB (Management Information Base)。 下面简述这三部分的作用。

- SNMP本身：定义了管理站和代理之间所交换的分组格式。所交换的分组包含各代理中的对象(变量)名及其状态(值)。SNMP负责读取和改变这些数值
- SMI：定义了命名对象和定义对象类型（包括范围和长度）的通用规则，以及把对象和对象的值进行编码的规则。这样做是为了确保网络管理数据的语法和语义的无二义性。但从 SMI的名称并不能看出它的功能。SMI并不定义一个实体应管理的对象数目，也不定义被管对象名以及对象名及其值之间的关联
- MIB：在被管理的实体中创建了命名对象，并规定了其类型

### 8、应用进程跨越网络的通信

#### 8.1、系统调用和应用编程接口

大多数操作系统使用系统调用 (system call ) 的机制在应用程序和操作系统之间传递控制权。对程序员来说，每一个系统调用和一般程序设计中的函数调用非常相似，只是系统调用是将控制权传递给了操作系统。 

当某个应用进程启动系统调用时，控制权就从应用进程传递给了系统调用接口。此接口再将控制权传递给计算机的操作系统。操作系统将此调用转给某个内部过程，并执行所请求的操作。内部过程一旦执行完毕，控制权就又通过系统调用接口返回给应用进程。

系统调用接口实际上就是应用进程的控制权和操作系统的控制权进行转换的一个接口——应用编程接口 API (Application Programming Interface)。

几种应用编程接口API： 

1. 套接字接口 (socket interface)：Berkeley UNIX操作系统定义了一种API
2. Windows Socket：微软公司在其操作系统中采用了套接字接口API，形成了一个稍有不同的API
3.  TLI (Transport Layer Interface)：AT&T为其 UNIX系统 V定义了一种API

应用进程通过套接字接入到网络：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201230173941043.png" alt="image-20201230173941043" style="zoom:50%;" />

套接字的作用 ：

- 当应用进程需要使用网络进行通信时就发出系统调用，请求操作系统为其创建“套接字”，以便把网络通信所需要的系统资源分配给该应用进程
- 操作系统为这些资源的总和用一个叫做套接字描述符的号码来表示，并把此号码返回给应用进程。应用进程所进行的网络操作都必须使用这个号码
- 通信完毕后，应用进程通过一个关闭套接字的系统调用通知操作系统回收与该“号码”相关的所有资源

#### 8.2、几种常用的系统调用

##### 8.2.1、连接建立阶段

当套接字被创建后，它的端口号和 IP地址都是空的，因此应用进程要调用bind(绑定)来指明套接字的本地地址。在服务器端调用 bind时就是把熟知端口号和本地 IP地址填写到已创建的套接字中。这就叫做把本地地址绑定到套接字。

服务器在调用bind 后，还必须调用listen(收听)把套接字设置为被动方式，以便随时接受客户的服务请求。UDP服务器由于只提供无连接服务，不使用listen 系统调用。

服务器紧接着就调用accept（接受），以便把远地客户进程发来的连接请求提取出来。系统调用accept 的一个变量就是要指明从哪一个套接字发起的连接。

##### 8.2.2、传送阶段

客户和服务器都在 TCP连接上使用 send系统调用传送数据，使用 recv系统调用接收数据。通常客户使用 send发送请求，而服务器使用 send发送回答。服务器使用 recv接收客户用 send调用发送的请求。客户在发完请求后用 recv接收回答。

##### 8.2.3、连接释放阶段

一旦客户或服务器结束使用套接字，就把套接字撤消。这时就调用 close释放连接和撤销套接字。

### 9、P2P应用

P2P文件分发不需要使用集中式的媒体服务器，而所有的音频/视频文件都是在普通的互联网用户之，间传输的。这其实是相当于有很多(有时达到上百万个)分散在各地的媒体服务器(由普通用户的计算机充当这种媒体服务器)向其他用户提供所要下载的音频/视频文件。这种P2P文件分发方式解决了集中式媒体服务器可能出现的瓶颈问题。

#### 9.1、集中目录服务器P2P

最早出现的 P2P 技术，可提供免费下载 MP3 音乐。

Napster能够搜索音乐文件，能够提供检索功能。所有的音乐文件地址集中存放在一个 Napster目录服务器中。使用者可很方便地下载需要的 MP3文件。

用户要及时向 Napster的目录服务器报告自己存有的音乐文件。当用户想下载某个 MP3文件时，就向目录服务器发出询问。目录服务器检索出结果后向用户返回存放此文件的 PC机的 IP地址。Napster的文件传输是分散的，但文件的定位则是集中的。

**这种集中式目录服务器的缺点就是可靠性差**。Napster被判决属于“间接侵害版权”，因此在 2000年 7月底 Napster网站就被迫关闭了。

#### 9.2、全分布式结构的P2P

电骡eMule 使用分散定位和分散传输技术，把每一个文件划分为许多小文件块，并使用多源文件传输协议 MFTP进行传送。因此用户可以同时从很多地方下载一个文件中的不同文件块。由于每一个文件块都很小，并且是并行下载，所以下载可以比较快地完成。

eMule用户在下载文件的同时，也在上传文件，因此，互联网上成千上万的 eMule用户在同时下载和上传一个个小的文件块。

- eMule的其他特点：
  - eMule使用了一些服务器，这些服务器并不是保存音频/视频文件，而是保存用户的有关信息，可以告诉用户从哪些地方可以下载到所需的文件
  - eMule使用了专门定义的文件夹，让用户存放可以和其他用户共享的文件
  - eMule的下载文件规则是鼓励用户向其他用户上传文件。用户上传文件越多，其下载文件的优先级就越高，因而下载就越快

使用P2P的比特洪流BT：BitTorrent把参与某个文件分发的所有对等方的集合称为一个洪流(torrent)。下载文件的数据单元为长度固定的文件块(chunk)，其长度是固定不变的。基础设施结点叫做追踪器(tracker)。 

- BT协议：
  - 当一个新的对等方 A加入洪流时，追踪器就随机地从参与的对等方集合中选择若干个（如30 个），并把这些对等方的 IP地址告诉A。于是 A就和这些对等方建立了 TCP连接。所有与 A 建立了 TCP连接的对等方为“相邻对等方”(neighboring peers)
  - A使用最稀有的优先(rarest first) 的技术，先应当请求副本最少的文件块(即最稀有的)。凡当前有以最高数据率向A传送文件块的某相邻对等方，A就优先把所请求的文件块传送给该相邻对等方

#### 9.3、P2P文件分发的分析

有 $N$ 台主机从服务器下载一个大文件，长度为$F$ bit。假定主机与互联网连接的链路的上传速率和下载速率分别为 u<sub>i</sub>和d<sub>i</sub> ，单位都是bit/s。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20201230181219216.png" alt="image-20201230181219216" style="zoom: 50%;" />

在传统的客户-服务器方式下，计算给所有主机分发完毕的最短时间 $T_{cs}$。从服务器端考虑，$N$ 台主机共需要从服务器得到的数据总量(比特数)是 $NF$。如果服务器能够不停地以其上传速率 $u_s$ 向各主机传送数据，一直到各主机都收到文件F，就需要时间 $NF/u_s$，单位是秒。由此可见，$T_{cs}$ 不可能小于$NF/u_s$ 。
如果 $N$ 台主机都以各自的下载速率不停地下载文件 $F$,那么下载速率最慢的主机(设其下载速率为 *d*<sub>min</sub>) 的下载文件时间(*F*/d<sub>min</sub>)， 将是$N$个下载时间中最大的一个。由此可见，$T_{cs}$ 也不可能小于 *F*/d<sub>min</sub> 。
如果$NF/u_s$ ≥ $F/d_{min}$，则瓶颈在服务器端的接入链路。这时 $T_{cs}$ = $NF/u_s$
如果$F/d_{min}$≥ $NF/u_s$，则瓶颈在下载最慢的主机的接入链路。这时 $T_{cs}$ = $F/d_{min}$
由此可得出所有主机都下载完文件F的最少时间是：$T_{cs}=max(NF/u_s,F/d_{min})$

